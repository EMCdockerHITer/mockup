
define([
  'expect',
  'jquery',
  'sinon',
  'mockup-registry',
  'mockup-patterns-querystring'
], function(expect, $, sinon, registry, Querystring) {
  'use strict';

  window.mocha.setup('bdd');
  $.fx.off = true;
  /* This is the json found in tests/json/queryStringCriteria.json,
    converted to one line to not pollute the test */
  var queryStringCriteria = '{"sortable_indexes":{"sortable_title":{"operations":["plone.app.querystring.operation.string.contains","plone.app.querystring.operation.string.is"],"group":"Text","description":"The items title, transformed for sorting","vocabulary":null,"title":"Sortable Title","operators":{"plone.app.querystring.operation.string.contains":{"widget":"StringWidget","operation":"plone.app.querystring.queryparser._contains","description":null,"title":"Contains"},"plone.app.querystring.operation.string.is":{"widget":"StringWidget","operation":"plone.app.querystring.queryparser._equal","description":"Tip: you can use * to autocomplete.","title":"Is"}},"enabled":false,"values":{},"sortable":true},"end":{"operations":["plone.app.querystring.operation.date.lessThan","plone.app.querystring.operation.date.largerThan","plone.app.querystring.operation.date.between","plone.app.querystring.operation.date.lessThanRelativeDate","plone.app.querystring.operation.date.largerThanRelativeDate","plone.app.querystring.operation.date.today","plone.app.querystring.operation.date.beforeToday","plone.app.querystring.operation.date.afterToday"],"group":"Dates","description":"The end date and time of an event","vocabulary":null,"title":"Event end date","operators":{"plone.app.querystring.operation.date.today":{"widget":null,"operation":"plone.app.querystring.queryparser._today","description":"The current day","title":"Today"},"plone.app.querystring.operation.date.largerThanRelativeDate":{"widget":"RelativeDateWidget","operation":"plone.app.querystring.queryparser._moreThanRelativeDate","description":"Please enter the number in days.","title":"Within last"},"plone.app.querystring.operation.date.lessThan":{"widget":"DateWidget","operation":"plone.app.querystring.queryparser._lessThan","description":"Please use YYYYMMDD.","title":"Before date"},"plone.app.querystring.operation.date.largerThan":{"widget":"DateWidget","operation":"plone.app.querystring.queryparser._largerThan","description":"Please use YYYYMMDD.","title":"After date"},"plone.app.querystring.operation.date.lessThanRelativeDate":{"widget":"RelativeDateWidget","operation":"plone.app.querystring.queryparser._lessThanRelativeDate","description":"Please enter the number in days.","title":"Within next"},"plone.app.querystring.operation.date.beforeToday":{"widget":null,"operation":"plone.app.querystring.queryparser._beforeToday","description":"Before the current day","title":"Before today"},"plone.app.querystring.operation.date.between":{"widget":"DateRangeWidget","operation":"plone.app.querystring.queryparser._between","description":"Please use YYYYMMDD.","title":"Between dates"},"plone.app.querystring.operation.date.afterToday":{"widget":null,"operation":"plone.app.querystring.queryparser._afterToday","description":"After the current day","title":"After today"}},"enabled":true,"values":{},"sortable":true},"effective":{"operations":["plone.app.querystring.operation.date.lessThan","plone.app.querystring.operation.date.largerThan","plone.app.querystring.operation.date.between","plone.app.querystring.operation.date.lessThanRelativeDate","plone.app.querystring.operation.date.largerThanRelativeDate","plone.app.querystring.operation.date.today","plone.app.querystring.operation.date.beforeToday","plone.app.querystring.operation.date.afterToday"],"group":"Dates","description":"The time and date an item was first published","vocabulary":null,"title":"Effective date","operators":{"plone.app.querystring.operation.date.today":{"widget":null,"operation":"plone.app.querystring.queryparser._today","description":"The current day","title":"Today"},"plone.app.querystring.operation.date.largerThanRelativeDate":{"widget":"RelativeDateWidget","operation":"plone.app.querystring.queryparser._moreThanRelativeDate","description":"Please enter the number in days.","title":"Within last"},"plone.app.querystring.operation.date.lessThan":{"widget":"DateWidget","operation":"plone.app.querystring.queryparser._lessThan","description":"Please use YYYYMMDD.","title":"Before date"},"plone.app.querystring.operation.date.largerThan":{"widget":"DateWidget","operation":"plone.app.querystring.queryparser._largerThan","description":"Please use YYYYMMDD.","title":"After date"},"plone.app.querystring.operation.date.lessThanRelativeDate":{"widget":"RelativeDateWidget","operation":"plone.app.querystring.queryparser._lessThanRelativeDate","description":"Please enter the number in days.","title":"Within next"},"plone.app.querystring.operation.date.beforeToday":{"widget":null,"operation":"plone.app.querystring.queryparser._beforeToday","description":"Before the current day","title":"Before today"},"plone.app.querystring.operation.date.between":{"widget":"DateRangeWidget","operation":"plone.app.querystring.queryparser._between","description":"Please use YYYYMMDD.","title":"Between dates"},"plone.app.querystring.operation.date.afterToday":{"widget":null,"operation":"plone.app.querystring.queryparser._afterToday","description":"After the current day","title":"After today"}},"enabled":true,"values":{},"sortable":true},"created":{"operations":["plone.app.querystring.operation.date.lessThan","plone.app.querystring.operation.date.largerThan","plone.app.querystring.operation.date.between","plone.app.querystring.operation.date.lessThanRelativeDate","plone.app.querystring.operation.date.largerThanRelativeDate","plone.app.querystring.operation.date.today","plone.app.querystring.operation.date.beforeToday","plone.app.querystring.operation.date.afterToday"],"group":"Dates","description":"The date an item was created","vocabulary":null,"title":"Creation date","operators":{"plone.app.querystring.operation.date.today":{"widget":null,"operation":"plone.app.querystring.queryparser._today","description":"The current day","title":"Today"},"plone.app.querystring.operation.date.largerThanRelativeDate":{"widget":"RelativeDateWidget","operation":"plone.app.querystring.queryparser._moreThanRelativeDate","description":"Please enter the number in days.","title":"Within last"},"plone.app.querystring.operation.date.lessThan":{"widget":"DateWidget","operation":"plone.app.querystring.queryparser._lessThan","description":"Please use YYYYMMDD.","title":"Before date"},"plone.app.querystring.operation.date.largerThan":{"widget":"DateWidget","operation":"plone.app.querystring.queryparser._largerThan","description":"Please use YYYYMMDD.","title":"After date"},"plone.app.querystring.operation.date.lessThanRelativeDate":{"widget":"RelativeDateWidget","operation":"plone.app.querystring.queryparser._lessThanRelativeDate","description":"Please enter the number in days.","title":"Within next"},"plone.app.querystring.operation.date.beforeToday":{"widget":null,"operation":"plone.app.querystring.queryparser._beforeToday","description":"Before the current day","title":"Before today"},"plone.app.querystring.operation.date.between":{"widget":"DateRangeWidget","operation":"plone.app.querystring.queryparser._between","description":"Please use YYYYMMDD.","title":"Between dates"},"plone.app.querystring.operation.date.afterToday":{"widget":null,"operation":"plone.app.querystring.queryparser._afterToday","description":"After the current day","title":"After today"}},"enabled":true,"values":{},"sortable":true},"expires":{"operations":["plone.app.querystring.operation.date.lessThan","plone.app.querystring.operation.date.largerThan","plone.app.querystring.operation.date.between","plone.app.querystring.operation.date.lessThanRelativeDate","plone.app.querystring.operation.date.largerThanRelativeDate","plone.app.querystring.operation.date.today","plone.app.querystring.operation.date.beforeToday","plone.app.querystring.operation.date.afterToday"],"group":"Dates","description":"The time and date an item was expired","vocabulary":null,"title":"Expiration date","operators":{"plone.app.querystring.operation.date.today":{"widget":null,"operation":"plone.app.querystring.queryparser._today","description":"The current day","title":"Today"},"plone.app.querystring.operation.date.largerThanRelativeDate":{"widget":"RelativeDateWidget","operation":"plone.app.querystring.queryparser._moreThanRelativeDate","description":"Please enter the number in days.","title":"Within last"},"plone.app.querystring.operation.date.lessThan":{"widget":"DateWidget","operation":"plone.app.querystring.queryparser._lessThan","description":"Please use YYYYMMDD.","title":"Before date"},"plone.app.querystring.operation.date.largerThan":{"widget":"DateWidget","operation":"plone.app.querystring.queryparser._largerThan","description":"Please use YYYYMMDD.","title":"After date"},"plone.app.querystring.operation.date.lessThanRelativeDate":{"widget":"RelativeDateWidget","operation":"plone.app.querystring.queryparser._lessThanRelativeDate","description":"Please enter the number in days.","title":"Within next"},"plone.app.querystring.operation.date.beforeToday":{"widget":null,"operation":"plone.app.querystring.queryparser._beforeToday","description":"Before the current day","title":"Before today"},"plone.app.querystring.operation.date.between":{"widget":"DateRangeWidget","operation":"plone.app.querystring.queryparser._between","description":"Please use YYYYMMDD.","title":"Between dates"},"plone.app.querystring.operation.date.afterToday":{"widget":null,"operation":"plone.app.querystring.queryparser._afterToday","description":"After the current day","title":"After today"}},"enabled":true,"values":{},"sortable":true},"modified":{"operations":["plone.app.querystring.operation.date.lessThan","plone.app.querystring.operation.date.largerThan","plone.app.querystring.operation.date.between","plone.app.querystring.operation.date.lessThanRelativeDate","plone.app.querystring.operation.date.largerThanRelativeDate","plone.app.querystring.operation.date.today","plone.app.querystring.operation.date.beforeToday","plone.app.querystring.operation.date.afterToday"],"group":"Dates","description":"The time and date an item was last modified","vocabulary":null,"title":"Modification date","operators":{"plone.app.querystring.operation.date.today":{"widget":null,"operation":"plone.app.querystring.queryparser._today","description":"The current day","title":"Today"},"plone.app.querystring.operation.date.largerThanRelativeDate":{"widget":"RelativeDateWidget","operation":"plone.app.querystring.queryparser._moreThanRelativeDate","description":"Please enter the number in days.","title":"Within last"},"plone.app.querystring.operation.date.lessThan":{"widget":"DateWidget","operation":"plone.app.querystring.queryparser._lessThan","description":"Please use YYYYMMDD.","title":"Before date"},"plone.app.querystring.operation.date.largerThan":{"widget":"DateWidget","operation":"plone.app.querystring.queryparser._largerThan","description":"Please use YYYYMMDD.","title":"After date"},"plone.app.querystring.operation.date.lessThanRelativeDate":{"widget":"RelativeDateWidget","operation":"plone.app.querystring.queryparser._lessThanRelativeDate","description":"Please enter the number in days.","title":"Within next"},"plone.app.querystring.operation.date.beforeToday":{"widget":null,"operation":"plone.app.querystring.queryparser._beforeToday","description":"Before the current day","title":"Before today"},"plone.app.querystring.operation.date.between":{"widget":"DateRangeWidget","operation":"plone.app.querystring.queryparser._between","description":"Please use YYYYMMDD.","title":"Between dates"},"plone.app.querystring.operation.date.afterToday":{"widget":null,"operation":"plone.app.querystring.queryparser._afterToday","description":"After the current day","title":"After today"}},"enabled":true,"values":{},"sortable":true},"getId":{"operations":["plone.app.querystring.operation.string.is"],"group":"Metadata","description":"The short name of an item (used in the url)","vocabulary":null,"title":"Short name (id)","operators":{"plone.app.querystring.operation.string.is":{"widget":"StringWidget","operation":"plone.app.querystring.queryparser._equal","description":"Tip: you can use * to autocomplete.","title":"Is"}},"enabled":true,"values":{},"sortable":true},"start":{"operations":["plone.app.querystring.operation.date.lessThan","plone.app.querystring.operation.date.largerThan","plone.app.querystring.operation.date.between","plone.app.querystring.operation.date.lessThanRelativeDate","plone.app.querystring.operation.date.largerThanRelativeDate","plone.app.querystring.operation.date.today","plone.app.querystring.operation.date.beforeToday","plone.app.querystring.operation.date.afterToday"],"group":"Dates","description":"The start date and time of an event","vocabulary":null,"title":"Event start date","operators":{"plone.app.querystring.operation.date.today":{"widget":null,"operation":"plone.app.querystring.queryparser._today","description":"The current day","title":"Today"},"plone.app.querystring.operation.date.largerThanRelativeDate":{"widget":"RelativeDateWidget","operation":"plone.app.querystring.queryparser._moreThanRelativeDate","description":"Please enter the number in days.","title":"Within last"},"plone.app.querystring.operation.date.lessThan":{"widget":"DateWidget","operation":"plone.app.querystring.queryparser._lessThan","description":"Please use YYYYMMDD.","title":"Before date"},"plone.app.querystring.operation.date.largerThan":{"widget":"DateWidget","operation":"plone.app.querystring.queryparser._largerThan","description":"Please use YYYYMMDD.","title":"After date"},"plone.app.querystring.operation.date.lessThanRelativeDate":{"widget":"RelativeDateWidget","operation":"plone.app.querystring.queryparser._lessThanRelativeDate","description":"Please enter the number in days.","title":"Within next"},"plone.app.querystring.operation.date.beforeToday":{"widget":null,"operation":"plone.app.querystring.queryparser._beforeToday","description":"Before the current day","title":"Before today"},"plone.app.querystring.operation.date.between":{"widget":"DateRangeWidget","operation":"plone.app.querystring.queryparser._between","description":"Please use YYYYMMDD.","title":"Between dates"},"plone.app.querystring.operation.date.afterToday":{"widget":null,"operation":"plone.app.querystring.queryparser._afterToday","description":"After the current day","title":"After today"}},"enabled":true,"values":{},"sortable":true},"Creator":{"operations":["plone.app.querystring.operation.string.is","plone.app.querystring.operation.string.currentUser"],"group":"Metadata","description":"The person that created an item","vocabulary":null,"title":"Creator","operators":{"plone.app.querystring.operation.string.currentUser":{"widget":null,"operation":"plone.app.querystring.queryparser._currentUser","description":"The user viewing the querystring results","title":"Current logged in user"},"plone.app.querystring.operation.string.is":{"widget":"UserPickerWidget","operation":"plone.app.querystring.queryparser._equal","description":"Tip: you can use * to autocomplete.","title":"Is"}},"enabled":true,"values":{},"sortable":true},"review_state":{"operations":["plone.app.querystring.operation.selection.is"],"group":"Metadata","description":"An items workflow state (e.g.published)","vocabulary":"plone.app.vocabularies.WorkflowStates","title":"Review state","operators":{"plone.app.querystring.operation.selection.is":{"widget":"MultipleSelectionWidget","operation":"plone.app.querystring.queryparser._equal","description":"Tip: you can use * to autocomplete.","title":"Is"}},"enabled":true,"values":{"private":{"title":"Private [private]"},"visible":{"title":"Public draft [visible]"},"internal":{"title":"Internal draft [internal]"},"external":{"title":"Externally visible [external]"},"published":{"title":"Published [published]"},"internally_published":{"title":"Internally published [internally_published]"},"pending":{"title":"Pending [pending]"}},"sortable":true},"Subject":{"operations":["plone.app.querystring.operation.selection.is"],"group":"Text","description":"Tags are used for organization of content","vocabulary":"plone.app.vocabularies.Keywords","title":"Tag","operators":{"plone.app.querystring.operation.selection.is":{"widget":"MultipleSelectionWidget","operation":"plone.app.querystring.queryparser._equal","description":"Tip: you can use * to autocomplete.","title":"Is"}},"enabled":true,"values":{},"sortable":true}},"indexes":{"start":{"operations":["plone.app.querystring.operation.date.lessThan","plone.app.querystring.operation.date.largerThan","plone.app.querystring.operation.date.between","plone.app.querystring.operation.date.lessThanRelativeDate","plone.app.querystring.operation.date.largerThanRelativeDate","plone.app.querystring.operation.date.today","plone.app.querystring.operation.date.beforeToday","plone.app.querystring.operation.date.afterToday"],"group":"Dates","description":"The start date and time of an event","vocabulary":null,"title":"Event start date","operators":{"plone.app.querystring.operation.date.today":{"widget":null,"operation":"plone.app.querystring.queryparser._today","description":"The current day","title":"Today"},"plone.app.querystring.operation.date.largerThanRelativeDate":{"widget":"RelativeDateWidget","operation":"plone.app.querystring.queryparser._moreThanRelativeDate","description":"Please enter the number in days.","title":"Within last"},"plone.app.querystring.operation.date.lessThan":{"widget":"DateWidget","operation":"plone.app.querystring.queryparser._lessThan","description":"Please use YYYYMMDD.","title":"Before date"},"plone.app.querystring.operation.date.largerThan":{"widget":"DateWidget","operation":"plone.app.querystring.queryparser._largerThan","description":"Please use YYYYMMDD.","title":"After date"},"plone.app.querystring.operation.date.lessThanRelativeDate":{"widget":"RelativeDateWidget","operation":"plone.app.querystring.queryparser._lessThanRelativeDate","description":"Please enter the number in days.","title":"Within next"},"plone.app.querystring.operation.date.beforeToday":{"widget":null,"operation":"plone.app.querystring.queryparser._beforeToday","description":"Before the current day","title":"Before today"},"plone.app.querystring.operation.date.between":{"widget":"DateRangeWidget","operation":"plone.app.querystring.queryparser._between","description":"Please use YYYYMMDD.","title":"Between dates"},"plone.app.querystring.operation.date.afterToday":{"widget":null,"operation":"plone.app.querystring.queryparser._afterToday","description":"After the current day","title":"After today"}},"enabled":true,"values":{},"sortable":true},"expires":{"operations":["plone.app.querystring.operation.date.lessThan","plone.app.querystring.operation.date.largerThan","plone.app.querystring.operation.date.between","plone.app.querystring.operation.date.lessThanRelativeDate","plone.app.querystring.operation.date.largerThanRelativeDate","plone.app.querystring.operation.date.today","plone.app.querystring.operation.date.beforeToday","plone.app.querystring.operation.date.afterToday"],"group":"Dates","description":"The time and date an item was expired","vocabulary":null,"title":"Expiration date","operators":{"plone.app.querystring.operation.date.today":{"widget":null,"operation":"plone.app.querystring.queryparser._today","description":"The current day","title":"Today"},"plone.app.querystring.operation.date.largerThanRelativeDate":{"widget":"RelativeDateWidget","operation":"plone.app.querystring.queryparser._moreThanRelativeDate","description":"Please enter the number in days.","title":"Within last"},"plone.app.querystring.operation.date.lessThan":{"widget":"DateWidget","operation":"plone.app.querystring.queryparser._lessThan","description":"Please use YYYYMMDD.","title":"Before date"},"plone.app.querystring.operation.date.largerThan":{"widget":"DateWidget","operation":"plone.app.querystring.queryparser._largerThan","description":"Please use YYYYMMDD.","title":"After date"},"plone.app.querystring.operation.date.lessThanRelativeDate":{"widget":"RelativeDateWidget","operation":"plone.app.querystring.queryparser._lessThanRelativeDate","description":"Please enter the number in days.","title":"Within next"},"plone.app.querystring.operation.date.beforeToday":{"widget":null,"operation":"plone.app.querystring.queryparser._beforeToday","description":"Before the current day","title":"Before today"},"plone.app.querystring.operation.date.between":{"widget":"DateRangeWidget","operation":"plone.app.querystring.queryparser._between","description":"Please use YYYYMMDD.","title":"Between dates"},"plone.app.querystring.operation.date.afterToday":{"widget":null,"operation":"plone.app.querystring.queryparser._afterToday","description":"After the current day","title":"After today"}},"enabled":true,"values":{},"sortable":true},"end":{"operations":["plone.app.querystring.operation.date.lessThan","plone.app.querystring.operation.date.largerThan","plone.app.querystring.operation.date.between","plone.app.querystring.operation.date.lessThanRelativeDate","plone.app.querystring.operation.date.largerThanRelativeDate","plone.app.querystring.operation.date.today","plone.app.querystring.operation.date.beforeToday","plone.app.querystring.operation.date.afterToday"],"group":"Dates","description":"The end date and time of an event","vocabulary":null,"title":"Event end date","operators":{"plone.app.querystring.operation.date.today":{"widget":null,"operation":"plone.app.querystring.queryparser._today","description":"The current day","title":"Today"},"plone.app.querystring.operation.date.largerThanRelativeDate":{"widget":"RelativeDateWidget","operation":"plone.app.querystring.queryparser._moreThanRelativeDate","description":"Please enter the number in days.","title":"Within last"},"plone.app.querystring.operation.date.lessThan":{"widget":"DateWidget","operation":"plone.app.querystring.queryparser._lessThan","description":"Please use YYYYMMDD.","title":"Before date"},"plone.app.querystring.operation.date.largerThan":{"widget":"DateWidget","operation":"plone.app.querystring.queryparser._largerThan","description":"Please use YYYYMMDD.","title":"After date"},"plone.app.querystring.operation.date.lessThanRelativeDate":{"widget":"RelativeDateWidget","operation":"plone.app.querystring.queryparser._lessThanRelativeDate","description":"Please enter the number in days.","title":"Within next"},"plone.app.querystring.operation.date.beforeToday":{"widget":null,"operation":"plone.app.querystring.queryparser._beforeToday","description":"Before the current day","title":"Before today"},"plone.app.querystring.operation.date.between":{"widget":"DateRangeWidget","operation":"plone.app.querystring.queryparser._between","description":"Please use YYYYMMDD.","title":"Between dates"},"plone.app.querystring.operation.date.afterToday":{"widget":null,"operation":"plone.app.querystring.queryparser._afterToday","description":"After the current day","title":"After today"}},"enabled":true,"values":{},"sortable":true},"Description":{"operations":["plone.app.querystring.operation.string.contains"],"group":"Text","description":"An items description","vocabulary":null,"title":"Description","operators":{"plone.app.querystring.operation.string.contains":{"widget":"StringWidget","operation":"plone.app.querystring.queryparser._contains","description":null,"title":"Contains"}},"enabled":true,"values":{},"sortable":false},"effective":{"operations":["plone.app.querystring.operation.date.lessThan","plone.app.querystring.operation.date.largerThan","plone.app.querystring.operation.date.between","plone.app.querystring.operation.date.lessThanRelativeDate","plone.app.querystring.operation.date.largerThanRelativeDate","plone.app.querystring.operation.date.today","plone.app.querystring.operation.date.beforeToday","plone.app.querystring.operation.date.afterToday"],"group":"Dates","description":"The time and date an item was first published","vocabulary":null,"title":"Effective date","operators":{"plone.app.querystring.operation.date.today":{"widget":null,"operation":"plone.app.querystring.queryparser._today","description":"The current day","title":"Today"},"plone.app.querystring.operation.date.largerThanRelativeDate":{"widget":"RelativeDateWidget","operation":"plone.app.querystring.queryparser._moreThanRelativeDate","description":"Please enter the number in days.","title":"Within last"},"plone.app.querystring.operation.date.lessThan":{"widget":"DateWidget","operation":"plone.app.querystring.queryparser._lessThan","description":"Please use YYYYMMDD.","title":"Before date"},"plone.app.querystring.operation.date.largerThan":{"widget":"DateWidget","operation":"plone.app.querystring.queryparser._largerThan","description":"Please use YYYYMMDD.","title":"After date"},"plone.app.querystring.operation.date.lessThanRelativeDate":{"widget":"RelativeDateWidget","operation":"plone.app.querystring.queryparser._lessThanRelativeDate","description":"Please enter the number in days.","title":"Within next"},"plone.app.querystring.operation.date.beforeToday":{"widget":null,"operation":"plone.app.querystring.queryparser._beforeToday","description":"Before the current day","title":"Before today"},"plone.app.querystring.operation.date.between":{"widget":"DateRangeWidget","operation":"plone.app.querystring.queryparser._between","description":"Please use YYYYMMDD.","title":"Between dates"},"plone.app.querystring.operation.date.afterToday":{"widget":null,"operation":"plone.app.querystring.queryparser._afterToday","description":"After the current day","title":"After today"}},"enabled":true,"values":{},"sortable":true},"Title":{"operations":["plone.app.querystring.operation.string.contains"],"group":"Text","description":"Text search of an items title","vocabulary":null,"title":"Title","operators":{"plone.app.querystring.operation.string.contains":{"widget":"StringWidget","operation":"plone.app.querystring.queryparser._contains","description":null,"title":"Contains"}},"enabled":true,"values":{},"sortable":false},"portal_type":{"operations":["plone.app.querystring.operation.selection.is"],"group":"Metadata","description":"An items type (e.g. Event)","vocabulary":"plone.app.vocabularies.ReallyUserFriendlyTypes","title":"Type","operators":{"plone.app.querystring.operation.selection.is":{"widget":"MultipleSelectionWidget","operation":"plone.app.querystring.queryparser._equal","description":"Tip: you can use * to autocomplete.","title":"Is"}},"enabled":true,"values":{"Document":{"title":"Page"},"Image":{"title":"Image"},"Collection":{"title":"Collection"},"Event":{"title":"Event"},"Link":{"title":"Link"},"File":{"title":"File"},"Discussion Item":{"title":"Comment"},"News Item":{"title":"News Item"},"Folder":{"title":"Folder"}},"sortable":false},"created":{"operations":["plone.app.querystring.operation.date.lessThan","plone.app.querystring.operation.date.largerThan","plone.app.querystring.operation.date.between","plone.app.querystring.operation.date.lessThanRelativeDate","plone.app.querystring.operation.date.largerThanRelativeDate","plone.app.querystring.operation.date.today","plone.app.querystring.operation.date.beforeToday","plone.app.querystring.operation.date.afterToday"],"group":"Dates","description":"The date an item was created","vocabulary":null,"title":"Creation date","operators":{"plone.app.querystring.operation.date.today":{"widget":null,"operation":"plone.app.querystring.queryparser._today","description":"The current day","title":"Today"},"plone.app.querystring.operation.date.largerThanRelativeDate":{"widget":"RelativeDateWidget","operation":"plone.app.querystring.queryparser._moreThanRelativeDate","description":"Please enter the number in days.","title":"Within last"},"plone.app.querystring.operation.date.lessThan":{"widget":"DateWidget","operation":"plone.app.querystring.queryparser._lessThan","description":"Please use YYYYMMDD.","title":"Before date"},"plone.app.querystring.operation.date.largerThan":{"widget":"DateWidget","operation":"plone.app.querystring.queryparser._largerThan","description":"Please use YYYYMMDD.","title":"After date"},"plone.app.querystring.operation.date.lessThanRelativeDate":{"widget":"RelativeDateWidget","operation":"plone.app.querystring.queryparser._lessThanRelativeDate","description":"Please enter the number in days.","title":"Within next"},"plone.app.querystring.operation.date.beforeToday":{"widget":null,"operation":"plone.app.querystring.queryparser._beforeToday","description":"Before the current day","title":"Before today"},"plone.app.querystring.operation.date.between":{"widget":"DateRangeWidget","operation":"plone.app.querystring.queryparser._between","description":"Please use YYYYMMDD.","title":"Between dates"},"plone.app.querystring.operation.date.afterToday":{"widget":null,"operation":"plone.app.querystring.queryparser._afterToday","description":"After the current day","title":"After today"}},"enabled":true,"values":{},"sortable":true},"modified":{"operations":["plone.app.querystring.operation.date.lessThan","plone.app.querystring.operation.date.largerThan","plone.app.querystring.operation.date.between","plone.app.querystring.operation.date.lessThanRelativeDate","plone.app.querystring.operation.date.largerThanRelativeDate","plone.app.querystring.operation.date.today","plone.app.querystring.operation.date.beforeToday","plone.app.querystring.operation.date.afterToday"],"group":"Dates","description":"The time and date an item was last modified","vocabulary":null,"title":"Modification date","operators":{"plone.app.querystring.operation.date.today":{"widget":null,"operation":"plone.app.querystring.queryparser._today","description":"The current day","title":"Today"},"plone.app.querystring.operation.date.largerThanRelativeDate":{"widget":"RelativeDateWidget","operation":"plone.app.querystring.queryparser._moreThanRelativeDate","description":"Please enter the number in days.","title":"Within last"},"plone.app.querystring.operation.date.lessThan":{"widget":"DateWidget","operation":"plone.app.querystring.queryparser._lessThan","description":"Please use YYYYMMDD.","title":"Before date"},"plone.app.querystring.operation.date.largerThan":{"widget":"DateWidget","operation":"plone.app.querystring.queryparser._largerThan","description":"Please use YYYYMMDD.","title":"After date"},"plone.app.querystring.operation.date.lessThanRelativeDate":{"widget":"RelativeDateWidget","operation":"plone.app.querystring.queryparser._lessThanRelativeDate","description":"Please enter the number in days.","title":"Within next"},"plone.app.querystring.operation.date.beforeToday":{"widget":null,"operation":"plone.app.querystring.queryparser._beforeToday","description":"Before the current day","title":"Before today"},"plone.app.querystring.operation.date.between":{"widget":"DateRangeWidget","operation":"plone.app.querystring.queryparser._between","description":"Please use YYYYMMDD.","title":"Between dates"},"plone.app.querystring.operation.date.afterToday":{"widget":null,"operation":"plone.app.querystring.queryparser._afterToday","description":"After the current day","title":"After today"}},"enabled":true,"values":{},"sortable":true},"getId":{"operations":["plone.app.querystring.operation.string.is"],"group":"Metadata","description":"The short name of an item (used in the url)","vocabulary":null,"title":"Short name (id)","operators":{"plone.app.querystring.operation.string.is":{"widget":"StringWidget","operation":"plone.app.querystring.queryparser._equal","description":"Tip: you can use * to autocomplete.","title":"Is"}},"enabled":true,"values":{},"sortable":true},"SearchableText":{"operations":["plone.app.querystring.operation.string.contains"],"group":"Text","description":"Text search of an items contents","vocabulary":null,"title":"Searchable text","operators":{"plone.app.querystring.operation.string.contains":{"widget":"StringWidget","operation":"plone.app.querystring.queryparser._contains","description":null,"title":"Contains"}},"enabled":true,"values":{},"sortable":false},"effectiveRange":{"operations":[],"group":"Dates","description":"Querying this is undefined","vocabulary":null,"title":"Effective range","operators":{},"enabled":false,"values":{},"sortable":false},"sortable_title":{"operations":["plone.app.querystring.operation.string.contains","plone.app.querystring.operation.string.is"],"group":"Text","description":"The items title, transformed for sorting","vocabulary":null,"title":"Sortable Title","operators":{"plone.app.querystring.operation.string.contains":{"widget":"StringWidget","operation":"plone.app.querystring.queryparser._contains","description":null,"title":"Contains"},"plone.app.querystring.operation.string.is":{"widget":"StringWidget","operation":"plone.app.querystring.queryparser._equal","description":"Tip: you can use * to autocomplete.","title":"Is"}},"enabled":false,"values":{},"sortable":true},"Creator":{"operations":["plone.app.querystring.operation.string.is","plone.app.querystring.operation.string.currentUser"],"group":"Metadata","description":"The person that created an item","vocabulary":null,"title":"Creator","operators":{"plone.app.querystring.operation.string.currentUser":{"widget":null,"operation":"plone.app.querystring.queryparser._currentUser","description":"The user viewing the querystring results","title":"Current logged in user"},"plone.app.querystring.operation.string.is":{"widget":"UserPickerWidget","operation":"plone.app.querystring.queryparser._equal","description":"Tip: you can use * to autocomplete.","title":"Is"}},"enabled":true,"values":{},"sortable":true},"getObjPositionInParent":{"operations":["plone.app.querystring.operation.int.is","plone.app.querystring.operation.int.lessThan","plone.app.querystring.operation.int.greaterThan"],"group":"Metadata","description":"The order of an item in its parent folder","vocabulary":null,"title":"Order in folder","operators":{"plone.app.querystring.operation.int.lessThan":{"widget":"StringWidget","operation":"plone.app.querystring.queryparser._lessThan","description":null,"title":"Less than"},"plone.app.querystring.operation.int.is":{"widget":"StringWidget","operation":"plone.app.querystring.queryparser._equal","description":null,"title":"Equals"}},"enabled":false,"values":{},"sortable":false},"isFolderish":{"operations":["plone.app.querystring.operation.boolean.isTrue","plone.app.querystring.operation.boolean.isFalse"],"group":"Metadata","description":"Find items that can contain other objects","vocabulary":null,"title":"Folder-like","operators":{"plone.app.querystring.operation.boolean.isFalse":{"widget":null,"operation":"plone.app.querystring.queryparser._isFalse","description":null,"title":"No"},"plone.app.querystring.operation.boolean.isTrue":{"widget":null,"operation":"plone.app.querystring.queryparser._isTrue","description":null,"title":"Yes"}},"enabled":false,"values":{},"sortable":false},"path":{"operations":["plone.app.querystring.operation.string.relativePath","plone.app.querystring.operation.string.path"],"group":"Metadata","description":"The location of an item ","vocabulary":null,"title":"Location","operators":{"plone.app.querystring.operation.string.relativePath":{"widget":"RelativePathWidget","operation":"plone.app.querystring.queryparser._relativePath","description":"Use to navigate to parent objects.","title":"Relative path"},"plone.app.querystring.operation.string.path":{"widget":"ReferenceWidget","operation":"plone.app.querystring.queryparser._path","description":"Location in the site structure","title":"Absolute path"}},"enabled":true,"values":{},"sortable":false},"getRawRelatedItems":{"operations":["plone.app.querystring.operation.reference.is"],"group":"Metadata","description":"Find items related to the selected items","vocabulary":null,"title":"Related To","operators":{"plone.app.querystring.operation.reference.is":{"widget":"ReferenceWidget","operation":"plone.app.querystring.queryparser._referenceIs","description":null,"title":"Equals"}},"enabled":false,"values":{},"sortable":false},"isDefaultPage":{"operations":["plone.app.querystring.operation.boolean.isTrue","plone.app.querystring.operation.boolean.isFalse"],"group":"Metadata","description":"Find items that are the default view for their containing folder.","vocabulary":null,"title":"Default Page","operators":{"plone.app.querystring.operation.boolean.isFalse":{"widget":null,"operation":"plone.app.querystring.queryparser._isFalse","description":null,"title":"No"},"plone.app.querystring.operation.boolean.isTrue":{"widget":null,"operation":"plone.app.querystring.queryparser._isTrue","description":null,"title":"Yes"}},"enabled":false,"values":{},"sortable":false},"review_state":{"operations":["plone.app.querystring.operation.selection.is"],"group":"Metadata","description":"An items workflow state (e.g.published)","vocabulary":"plone.app.vocabularies.WorkflowStates","title":"Review state","operators":{"plone.app.querystring.operation.selection.is":{"widget":"MultipleSelectionWidget","operation":"plone.app.querystring.queryparser._equal","description":"Tip: you can use * to autocomplete.","title":"Is"}},"enabled":true,"values":{"private":{"title":"Private [private]"},"visible":{"title":"Public draft [visible]"},"internal":{"title":"Internal draft [internal]"},"external":{"title":"Externally visible [external]"},"published":{"title":"Published [published]"},"internally_published":{"title":"Internally published [internally_published]"},"pending":{"title":"Pending [pending]"}},"sortable":true},"Subject":{"operations":["plone.app.querystring.operation.selection.is"],"group":"Text","description":"Tags are used for organization of content","vocabulary":"plone.app.vocabularies.Keywords","title":"Tag","operators":{"plone.app.querystring.operation.selection.is":{"widget":"MultipleSelectionWidget","operation":"plone.app.querystring.queryparser._equal","description":"Tip: you can use * to autocomplete.","title":"Is"}},"enabled":true,"values":{},"sortable":true}}}';

   /* ==========================
   TEST: Querystring
  ========================== */

  describe('Querystring', function () {

    beforeEach(function() {
      this.server = sinon.fakeServer.create();
      this.server.autoRespond = true;

      this.server.respondWith('GET', /queryStringCriteria\.json/, function (xhr, id) {
        xhr.respond(200, {'Content-Type': 'application/json'}, JSON.stringify(queryStringCriteria));
      });

    });

    afterEach(function() {
      $('body').empty();
      this.server.restore();
    });

    it('should convert the showPreviews option to bool', function () {
      var jsonstr =  '{ "showPreviews": "false" }';

      var $el = $('' +
        '<div>' +
        '<input class=\'pat-querystring\' data-pat-querystring=\'' + jsonstr + '\' />' +
        '</div>'
      ).appendTo('body');
      expect($('.pat-querystring').attr('style')).to.be(undefined);
      registry.scan($el);
      expect($('.pat-querystring').attr('style')).to.not.be(undefined);
      expect($('.pat-querystring').data().patternQuerystring.options.showPreviews).to.be(false);
    });

    it('should display the select criteria dropdown, sorting and preview', function () {
        /* This is the json found in tests/json/queryStringCriteria.json,
           converted to one line to not pollute the test */
      var $el = $('' +
        '<div>' +
        '<input class=\'pat-querystring\' data-pat-querystring=\'' + queryStringCriteria + '\' />' +
        '</div>'
      ).appendTo('body');
      expect($('.pat-querystring').attr('style')).to.be(undefined);
      registry.scan($el);
      expect($('.pat-querystring').attr('style')).to.not.be(undefined);
      expect($('.querystring-criteria-wrapper')).to.not.be.empty();
      expect($('.querystring-sort-wrapper')).to.not.be.empty();
      expect($('.querystring-preview-wrapper')).to.not.be.empty();
      expect($('select.select2-offscreen option').length).to.be(28);
      expect($('select.select2-offscreen option')[1].value).to.equal('start');


      /* Dates */
      /* Click the first dropdown, pick start date index */
      $('.querystring-criteria-wrapper .querystring-criteria-index:first select.select2-offscreen').select2('val', 'start', {triggerChange: true});
      expect( $('.querystring-criteria-operator .select2-chosen').text() ).to.be('Today');

      /* Click the operator dropdown, pick Within last */
      $('.querystring-criteria-wrapper .querystring-criteria-operator:first select.select2-offscreen').select2('val', 'plone.app.querystring.operation.date.largerThanRelativeDate', {triggerChange: true});
      $('.querystring-criteria-value input.querystring-criteria-value-RelativeDateWidget').val('2').trigger('change');
      expect( $('.querystring-criteria-value input.querystring-criteria-value-RelativeDateWidget').val() ).to.be('2');

      /* Click the operator dropdown, pick less Than */
      $('.querystring-criteria-wrapper .querystring-criteria-operator:first select.select2-offscreen').select2('val', 'plone.app.querystring.operation.date.lessThan', {triggerChange: true});
      expect( $('.querystring-criteria-value input.querystring-criteria-value-DateWidget')).to.not.be(undefined);

      /* Click the operator dropdown, pick larger Than */
      $('.querystring-criteria-wrapper .querystring-criteria-operator:first select.select2-offscreen').select2('val', 'plone.app.querystring.operation.date.largerThan', {triggerChange: true});

      /* Click the operator dropdown, pick less Than Relative Date */
      $('.querystring-criteria-wrapper .querystring-criteria-operator:first select.select2-offscreen').select2('val', 'plone.app.querystring.operation.date.lessThanRelativeDate', {triggerChange: true});
      expect( $('.querystring-criteria-value input.querystring-criteria-value-RelativeDateWidget')).to.not.be(undefined);

      /* Click the operator dropdown, pick before Today */
      $('.querystring-criteria-wrapper .querystring-criteria-operator:first select.select2-offscreen').select2('val', 'plone.app.querystring.operation.date.beforeToday', {triggerChange: true});
      expect($('.querystring-criteria-value').val()).to.be('');

      /* Click the operator dropdown, pick between */
      $('.querystring-criteria-wrapper .querystring-criteria-operator:first select.select2-offscreen').select2('val', 'plone.app.querystring.operation.date.between', {triggerChange: true});
      expect( $('.querystring-criteria-value input.querystring-criteria-value-DateWidget')).to.not.be(undefined);

      /* Click the operator dropdown, pick after Today */
      $('.querystring-criteria-wrapper .querystring-criteria-operator:first select.select2-offscreen').select2('val', 'plone.app.querystring.operation.date.afterToday', {triggerChange: true});
      expect($('.querystring-criteria-value').val()).to.be('');


      /* Text */
      /* Click the first dropdown, pick Description index */
      $('.querystring-criteria-wrapper .querystring-criteria-index:first select.select2-offscreen').select2('val', 'Description', {triggerChange: true});
      $('.querystring-criteria-value input.querystring-criteria-value-StringWidget').val('Hello World Description').trigger('change');
      expect( $('.querystring-criteria-operator .select2-chosen').text() ).to.be('Contains');
      expect( $('.querystring-criteria-value input.querystring-criteria-value-StringWidget').val() ).to.be('Hello World Description');


      /* Click the first dropdown, pick Title index */
      $('.querystring-criteria-wrapper .querystring-criteria-index:first select.select2-offscreen').select2('val', 'Title', {triggerChange: true});
      $('.querystring-criteria-value input.querystring-criteria-value-StringWidget').val('Hello World').trigger('change');
      expect( $('.querystring-criteria-operator .select2-chosen').text() ).to.be('Contains');
      expect( $('.querystring-criteria-value input.querystring-criteria-value-StringWidget').val() ).to.be('Hello World');

      /* Click the first dropdown, pick SearchableText index */
      $('.querystring-criteria-wrapper .querystring-criteria-index:first select.select2-offscreen').select2('val', 'SearchableText', {triggerChange: true});
      $('.querystring-criteria-value input.querystring-criteria-value-StringWidget').val('Hello World Text').trigger('change');
      expect( $('.querystring-criteria-operator .select2-chosen').text() ).to.be('Contains');
      expect( $('.querystring-criteria-value input.querystring-criteria-value-StringWidget').val() ).to.be('Hello World Text');

      /* Click the first dropdown, pick Subject index */
      $('.querystring-criteria-wrapper .querystring-criteria-index:first select.select2-offscreen').select2('val', 'Subject', {triggerChange: true});
      expect( $('.querystring-criteria-operator .select2-chosen').text() ).to.be('Is');
      /* XXX This is not done as I don't get the face server to run
      $('.querystring-criteria-value select.querystring-criteria-value-MultipleSelectionWidget').val('HelloWorld');
      expect( $('.querystring-criteria-value select.querystring-criteria-value-StringWidget').val() ).to.be('HelloWorld');
      */

      /* Metadata */
      /* Click the first dropdown, pick portal_type index */
      $('.querystring-criteria-wrapper .querystring-criteria-index:first select.select2-offscreen').select2('val', 'portal_type', {triggerChange: true});
      expect( $('.querystring-criteria-operator .select2-chosen').text() ).to.be('Is');
      /* XXX This is not done as I don't get the face server to run
      $('.querystring-criteria-value input.querystring-criteria-value-MultipleSelectionWidget').val('hello.world.document');
      expect( $('.querystring-criteria-value input.querystring-criteria-value-StringWidget').val() ).to.be('hello.world.document');
      */

      /* Click the first dropdown, pick getId index */
      $('.querystring-criteria-wrapper .querystring-criteria-index:first select.select2-offscreen').select2('val', 'getId', {triggerChange: true});
      $('.querystring-criteria-value input.querystring-criteria-value-StringWidget').val('hello-world').trigger('change');
      expect( $('.querystring-criteria-operator .select2-chosen').text() ).to.be('Is');
      expect( $('.querystring-criteria-value input.querystring-criteria-value-StringWidget').val() ).to.be('hello-world');

      /* Click the first dropdown, pick Creator index */
      $('.querystring-criteria-wrapper .querystring-criteria-index:first select.select2-offscreen').select2('val', 'Creator', {triggerChange: true});
      expect( $('.querystring-criteria-operator .select2-chosen').text() ).to.be('Current logged in user');

      /* Click the first dropdown, pick path index */
      $('.querystring-criteria-wrapper .querystring-criteria-index:first select.select2-offscreen').select2('val', 'path', {triggerChange: true});
      expect( $('.querystring-criteria-operator .select2-chosen').text() ).to.be('Relative path');

      /* Click the first dropdown, pick review_state index */
      $('.querystring-criteria-wrapper .querystring-criteria-index:first select.select2-offscreen').select2('val', 'review_state', {triggerChange: true});
      $('.querystring-criteria-value select.querystring-criteria-value-MultipleSelectionWidget').select2('val', 'pending', {triggerChange: true}).trigger('change');
      expect( $('.querystring-criteria-operator .select2-chosen').text() ).to.be('Is');
      expect( $('.querystring-criteria-value select.querystring-criteria-value-MultipleSelectionWidget').val() ).to.eql(['pending']);

      /* Test sorting */
      $('.querystring-sort-wrapper select.select2-offscreen').select2('val', 'sortable_title', {triggerChange: true});
      expect( $('.querystring-sort-wrapper .select2-chosen').text() ).to.be('Sortable Title');

      $('.querystring-sort-wrapper select.select2-offscreen').select2('val', 'end', {triggerChange: true});
      expect( $('.querystring-sort-wrapper .select2-chosen').text() ).to.be('Event end date');

      $('.querystring-sort-wrapper select.select2-offscreen').select2('val', 'effective', {triggerChange: true});
      expect( $('.querystring-sort-wrapper .select2-chosen').text() ).to.be('Effective date');

      $('.querystring-sort-wrapper select.select2-offscreen').select2('val', 'created', {triggerChange: true});
      expect( $('.querystring-sort-wrapper .select2-chosen').text() ).to.be('Creation date');

      $('.querystring-sort-wrapper select.select2-offscreen').select2('val', 'expires', {triggerChange: true});
      expect( $('.querystring-sort-wrapper .select2-chosen').text() ).to.be('Expiration date');

      $('.querystring-sort-wrapper select.select2-offscreen').select2('val', 'modified', {triggerChange: true});
      expect( $('.querystring-sort-wrapper .select2-chosen').text() ).to.be('Modification date');

      $('.querystring-sort-wrapper select.select2-offscreen').select2('val', 'getId', {triggerChange: true});
      expect( $('.querystring-sort-wrapper .select2-chosen').text() ).to.be('Short name (id)');

      $('.querystring-sort-wrapper select.select2-offscreen').select2('val', 'start', {triggerChange: true});
      expect( $('.querystring-sort-wrapper .select2-chosen').text() ).to.be('Event start date');

      $('.querystring-sort-wrapper select.select2-offscreen').select2('val', 'Creator', {triggerChange: true});
      expect( $('.querystring-sort-wrapper .select2-chosen').text() ).to.be('Creator');

      $('.querystring-sort-wrapper select.select2-offscreen').select2('val', 'review_state', {triggerChange: true});
      expect( $('.querystring-sort-wrapper .select2-chosen').text() ).to.be('Review state');

      $('.querystring-sort-wrapper select.select2-offscreen').select2('val', 'Subject', {triggerChange: true});
      expect( $('.querystring-sort-wrapper .select2-chosen').text() ).to.be('Tag');


      /* Reverse */
      $('.querystring-sortreverse input').click();
      expect( $('.querystring-sortreverse input').val() ).to.be('on');


      /* Cleanup */
      $('.querystring-criteria-remove').click();




    });
  });

});
