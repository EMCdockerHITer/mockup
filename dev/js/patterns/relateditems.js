define(["jquery","underscore","mockup-patterns-base","mockup-patterns-select2","mockup-patterns-queryhelper"],function(a,b,c,d,e){"use strict";var f=c.extend({name:"relateditems",browsing:!1,currentPath:null,defaults:{ajaxvocabulary:null,multiple:!0,tokenSeparators:[","," "],separator:",",orderable:!0,cache:!0,closeOnSelect:!1,basePath:"/",browseText:"Browse",searchText:"Search",homeText:"home",folderTypes:["Folder"],attributes:["UID","Title","Type","path"],dropdownCssClass:"pat-relateditems-dropdown",maximumSelectionSize:-1,resultTemplate:'<div class="pat-relateditems-result pat-relateditems-type-<%= Type %> <% if (selected) { %>pat-active<% } %>">  <a href="#" class="pat-relateditems-result-select">    <span class="pat-relateditems-result-title"><%= Title %></span>    <span class="pat-relateditems-result-path"><%= path %></span>  </a>  <span class="pat-relateditems-buttons">  <% if (folderish) { %>     <a class="pat-relateditems-result-browse" href="#" data-path="<%= path %>"></a>   <% } %> </span></div>',resultTemplateSelector:null,selectionTemplate:'<span class="pat-relateditems-item pat-relateditems-type-<%= Type %>"> <span class="pat-relateditems-item-title"><%= Title %></span> <span class="pat-relateditems-item-path"><%= path %></span></span>',selectionTemplateSelector:null,tabsTemplate:'<div class="pat-relateditems-tabs"> <a href="#" class="pat-relateditems-tabs-search pat-relateditems-tab pat-active"><%= searchText %></a> <a href="#" class="pat-relateditems-tabs-browse pat-relateditems-tab"><%= browseText %></a></div>',tabsTemplateSelector:null,breadCrumbsTemplate:'<span><a class="icon-home" href="/"></a><%= items %></span>',breadCrumbsTemplateSelector:null,breadCrumbTemplate:'/<a href="<%= path %>"><%= text %></a>',breadCrumbTemplateSelector:null,escapeMarkup:function(a){return a}},applyTemplate:function(c,d){var e,f=this;return f.options[c+"TemplateSelector"]?(e=a(f.options[c+"TemplateSelector"]).html(),e||(e=f.options[c+"Template"])):e=f.options[c+"Template"],b.template(e,d)},activateBrowsing:function(){var a=this;a.browsing=!0,a.setBreadCrumbs(),a.setTabs()},deactivateBrowsing:function(){var a=this;a.browsing=!1,a.setBreadCrumbs(),a.setTabs()},browseTo:function(a){var b=this;b.trigger("before-browse"),b.currentPath=a,b.activateBrowsing(),b.$el.select2("close"),b.$el.select2("open"),b.trigger("after-browse")},setTabs:function(){var a=this;a.browsing?(a.$browseBtn.addClass("pat-active"),a.$searchBtn.removeClass("pat-active")):(a.$browseBtn.removeClass("pat-active"),a.$searchBtn.addClass("pat-active"))},setBreadCrumbs:function(){var c=this,d=c.currentPath?c.currentPath:c.options.basePath;if(c.browsing){var e;if("/"===d)e=c.applyTemplate("breadCrumbs",{items:""});else{var f=d.split("/"),g="",h="";b.each(f,function(a){if(""!==a){var b={};g=g+"/"+a,b.text=a,b.path=g,h+=c.applyTemplate("breadCrumb",b)}}),e=c.applyTemplate("breadCrumbs",{items:h})}var i=a(e);a("a",i).on("click",function(){return c.browseTo(a(this).attr("href")),!1}),c.$browsePath.html(i)}else c.$browsePath.html("")},selectItem:function(a){var b=this;b.trigger("selecting");var c=b.$el.select2("data");c.push(a),b.$el.select2("data",c),a.selected=!0,b.trigger("selected")},deselectItem:function(a){var c=this;c.trigger("deselecting");var d=c.$el.select2("data");b.each(d,function(b,c){b.id===a.id&&d.splice(c,1)}),c.$el.select2("data",d),a.selected=!1,c.trigger("deselected")},init:function(){var c=this;c.query=new e(c.$el,a.extend(!0,{},c.options,{basePattern:c})),c.$el.wrap('<div class="pat-relateditems-container" />'),c.$container=c.$el.parents(".pat-relateditems-container"),c.$container.width(c.options.width),d.prototype.initializeValueMap.call(c),d.prototype.initializeTags.call(c),d.prototype.initializeOrdering.call(c),c.query.valid?c.options.ajax=c.query.selectAjax():c.options.tags=[],c.options.formatSelection=function(a){return c.applyTemplate("selection",a)},c.options.formatResult=function(d){if(d.folderish=d.Type&&-1!==b.indexOf(c.options.folderTypes,d.Type)?!0:!1,void 0===d.selected){var e=c.$el.select2("data");d.selected=!1,b.each(e,function(a){a.UID===d.UID&&(d.selected=!0)})}var f=a(c.applyTemplate("result",d));return a(".pat-relateditems-result-select",f).on("click",function(b){if(b.preventDefault(),a(this).is(".pat-active"))a(this).removeClass("pat-active"),c.deselectItem(d);else if(c.selectItem(d),a(this).addClass("pat-active"),c.options.maximumSelectionSize>0){var e=c.$select2.select2("data");e.length>=c.options.maximumSelectionSize&&c.$select2.select2("close")}}),a(".pat-relateditems-result-browse",f).on("click",function(b){b.preventDefault(),b.stopPropagation();var d=a(this).data("path");c.browseTo(d)}),a(f)},c.options.initSelection=function(b,d){var e=a(b).val();if(""!==e){var f=e.split(c.options.separator);c.query.search("UID","plone.app.querystring.operation.list.contains",f,function(a){d(a.results)},!1)}},c.options.id=function(a){return a.UID+"/"+Math.random()+Math.random()},d.prototype.initializeSelect2.call(c);var f={browseText:c.options.browseText,searchText:c.options.searchText};c.$browse=a(c.applyTemplate("tabs",f)),c.$container.prepend(c.$browse),c.$browseBtn=a(".pat-relateditems-tabs-browse",c.$browse),c.$searchBtn=a(".pat-relateditems-tabs-search",c.$browse),c.$browsePath=a('<span class="pat-relateditems-path" />'),c.$browse.after(c.$browsePath),c.deactivateBrowsing(),c.$browseBtn.click(function(){return c.activateBrowsing(),c.$el.select2("close"),c.$el.select2("open"),!1}),c.$searchBtn.click(function(){return c.deactivateBrowsing(),c.$el.select2("close"),c.$el.select2("open"),!1}),c.$el.on("select2-selecting",function(a){a.preventDefault()})}});return f});