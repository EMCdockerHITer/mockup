define(["jquery","mockup-patterns-base","mockup-patterns-select2","mockup-patterns-pickadate"],function(a,b,c,d,e){"use strict";var f=function(){this.init.apply(this,arguments)};f.prototype={defaults:{indexWidth:"20em",placeholder:"Select criteria",remove:"remove line",results:" items matching your search.",days:"days",betweendt:"to",classBetweenDtName:"querystring-criteria-betweendt",classWrapperName:"querystring-criteria-wrapper",classIndexName:"querystring-criteria-index",classOperatorName:"querystring-criteria-operator",classValueName:"querystring-criteria-value",classRemoveName:"querystring-criteria-remove",classResultsName:"querystring-criteria-results",classClearName:"querystring-criteria-clear"},init:function(b,c,d,f,g,h){var i=this;i.options=a.extend(!0,{},i.defaults,c),i.indexes=d,i.indexGroups={},i.$wrapper=a("<div/>").addClass(i.options.classWrapperName).appendTo(b),i.$remove=a("<div>"+i.options.remove+"</div>").addClass(i.options.classRemoveName).appendTo(i.$wrapper).on("click",function(){i.remove()}),i.$index=a("<select><option></option></select>").attr("placeholder",i.options.placeholder),a.each(i.indexes,function(b,c){c.enabled&&(i.indexGroups[c.group]||(i.indexGroups[c.group]=a("<optgroup/>").attr("label",c.group).appendTo(i.$index)),i.indexGroups[c.group].append(a("<option/>").attr("value",b).html(c.title)))}),i.$wrapper.append(a("<div/>").addClass(i.options.classIndexName).append(i.$index)),i.$index.patternSelect2({width:i.options.indexWidth,placeholder:i.options.placeholder}).on("change",function(a){i.removeValue(),i.createOperator(a.val),i.createClear(),i.trigger("index-changed")}),f!==e&&(i.$index.select2("val",f),i.createOperator(f,g,h),i.createClear()),i.trigger("create-criteria")},createOperator:function(b,c,d){var f=this;f.removeOperator(),f.$operator=a("<select/>"),f.indexes[b]&&a.each(f.indexes[b].operators,function(b,c){a("<option/>").attr("value",b).html(c.title).appendTo(f.$operator)}),f.$wrapper.append(a("<div/>").addClass(f.options.classOperatorName).append(f.$operator)),f.$operator.patternSelect2({width:"10em"}).on("change",function(){f.createValue(b),f.createClear(),f.trigger("operator-changed")}),c===e&&(c=f.$operator.select2("val")),f.$operator.select2("val",c),f.createValue(b,d),f.trigger("create-operator")},createValue:function(b,c){var d=this,f=d.indexes[b].operators[d.$operator.val()].widget,g=a("<div/>").addClass(d.options.classValueName).appendTo(d.$wrapper);if(d.removeValue(),"StringWidget"===f)d.$value=a('<input type="text"/>').addClass(d.options.classValueName+"-"+f).val(c).appendTo(g).change(function(){d.trigger("value-changed")});else if("DateWidget"===f)d.$value=a('<input type="text"/>').addClass(d.options.classValueName+"-"+f).appendTo(g).patternPickadate({time:!1,date:{format:"dd/mm/yyyy"}}).change(function(){d.trigger("value-changed")});else if("DateRangeWidget"===f){var h=a("<span/>").appendTo(g),i=a('<input type="text"/>').addClass(d.options.classValueName+"-"+f).addClass(d.options.classValueName+"-"+f+"-start").appendTo(h).patternPickadate({time:!1,date:{format:"dd/mm/yyyy"}});g.append(a("<span/>").html(d.options.betweendt).addClass(d.options.classBetweenDtName));var j=a("<span/>").appendTo(g),k=a('<input type="text"/>').addClass(d.options.classValueName+"-"+f).addClass(d.options.classValueName+"-"+f+"-end").appendTo(j).patternPickadate({time:!1,date:{format:"dd/mm/yyyy"}});g.find(".picker__input").change(function(){d.trigger("value-changed")}),d.$value=[i,k]}else"RelativeDateWidget"===f?d.$value=a('<input type="text"/>').after(a("<span/>").html(d.options.days)).addClass(d.options.classValueName+"-"+f).appendTo(g).change(function(){d.trigger("value-changed")}):"ReferenceWidget"===f?d.$value=a('<input type="text"/>').addClass(d.options.classValueName+"-"+f).appendTo(g).change(function(){d.trigger("value-changed")}):"RelativePathWidget"===f?d.$value=a('<input type="text"/>').addClass(d.options.classValueName+"-"+f).appendTo(g).val(c).change(function(){d.trigger("value-changed")}):"MultipleSelectionWidget"===f&&(d.$value=a("<select/>").attr("multiple",!0).addClass(d.options.classValueName+"-"+f).appendTo(g).change(function(){d.trigger("value-changed")}),d.indexes[b]&&a.each(d.indexes[b].values,function(b,c){a("<option/>").attr("value",b).html(c.title).appendTo(d.$value)}),d.$value.patternSelect2({width:"250px"}));c!==e&&"undefined"!=typeof d.$value&&d.$value.select2("val",c),d.trigger("create-value")},createClear:function(){var b=this;b.removeClear(),b.$clear=a("<div/>").addClass(b.options.classClearName).appendTo(b.$wrapper)},remove:function(){var a=this;a.trigger("remove"),a.$remove.remove(),a.$index.parent().remove(),a.removeOperator(),a.removeValue(),a.removeClear(),a.$wrapper.remove()},removeClear:function(){var a=this;a.trigger("remove-clear"),a.$clear&&a.$clear.remove()},removeOperator:function(){var a=this;a.trigger("remove-operator"),a.$operator&&a.$operator.parent().remove()},removeValue:function(){var b=this;b.trigger("remove-value"),b.$value&&(a.isArray(b.$value)?b.$value[0].parents(".querystring-criteria-value").remove():b.$value.parents(".querystring-criteria-value").remove())},buildQueryPart:function(){var b=this,c=b.$index.select2("val");if(""===c)return"";var d="query.i:records="+c;if("undefined"==typeof b.$operator)return"";var e=b.$operator.val(),f="query.o:records="+e,g="query.v:records=",h="query.v:records:list=",i=[];return"undefined"==typeof b.$value?i.push(g):a.isArray(b.$value)?a.each(b.$value,function(){i.push(h+a(this).parent().find(".picker__input").val())}):i.push(g+b.$value.val()),d+"&"+f+"&"+i.join("&")},getJSONListStr:function(){var b=this,c=b.$index.select2("val");if(""===c)return"";if("undefined"==typeof b.$operator)return"";var d=b.$operator.val(),e=[];a.isArray(b.$value)?a.each(b.$value,function(){e.push(a(this).parent().find(".picker__input").val())}):"undefined"!=typeof b.$value&&e.push(b.$value.val());var f;return f=e.length>1?'["'+e.join('","')+'"]':1===e.length?JSON.stringify(e[0]):'""','{"i":"'+c+'", "o":"'+d+'", "v":'+f+"}"},trigger:function(a){this.$wrapper.trigger(a+"-criteria.querystring.patterns",[this])},on:function(a,b){this.$wrapper.on(a+"-criteria.querystring.patterns",b)}};var g=b.extend({name:"querystring",defaults:{indexes:[],classWrapperName:"querystring-wrapper",criteria:{},indexOptionsUrl:null,previewURL:"portal_factory/@@querybuilder_html_results",previewCountURL:"portal_factory/@@querybuildernumberofresults",sorttxt:"Sort On",reversetxt:"Reversed Order",previewTitle:"Preview",previewDescription:"Preview of at most 10 items",classSortLabelName:"querystring-sort-label",classSortReverseName:"querystring-sortreverse",classSortReverseLabelName:"querystring-sortreverse-label",classPreviewCountWrapperName:"querystring-previewcount-wrapper",classPreviewResultsWrapperName:"querystring-previewresults-wrapper",classPreviewWrapperName:"querystring-preview-wrapper",classPreviewName:"querystring-preview",classPreviewTitleName:"querystring-preview-title",classPreviewDescriptionName:"querystring-preview-description",classSortWrapperName:"querystring-sort-wrapper",showPreviews:!0},init:function(){var b=this;b.$el.hide(),b.$wrapper=a("<div/>"),b.$el.after(b.$wrapper),b.initialized=!1,b.options.indexOptionsUrl?a.ajax({url:b.options.indexOptionsUrl,success:function(a){b.options.indexes=a.indexes,b.options.sortable_indexes=a.sortable_indexes,b._init()},error:function(){}}):b._init()},_init:function(){var b=this;b.$criteriaWrapper=a("<div/>").addClass(b.options.classWrapperName).appendTo(b.$wrapper),b.$sortWrapper=a("<div/>").addClass(b.options.classSortWrapperName).appendTo(b.$wrapper),"false"===b.options.showPreviews&&(b.options.showPreviews=!1),b.options.showPreviews&&(b.$previewWrapper=a("<div/>").addClass(b.options.classPreviewWrapperName).appendTo(b.$wrapper),a("<div/>").addClass(b.options.classPreviewTitleName).html(b.options.previewTitle).appendTo(b.$previewWrapper),a("<div/>").addClass(b.options.classPreviewDescriptionName).html(b.options.previewDescription).appendTo(b.$previewWrapper)),b.criterias=[],b.$el.val()&&a.each(JSON.parse(b.$el.val()),function(a,c){b.createCriteria(c.i,c.o,c.v)}),b.createCriteria(),b.createSort(),b.options.showPreviews&&b.refreshPreviewEvent(),b.$el.trigger("initialized"),b.initialized=!0},createCriteria:function(a,b,c){var d=this,e=new f(d.$criteriaWrapper,d.options.criteria,d.options.indexes,a,b,c);e.on("remove",function(){d.criterias[d.criterias.length-1]===e&&d.createCriteria()}),e.on("index-changed",function(){d.criterias[d.criterias.length-1]===e&&d.createCriteria()});var g=function(){d.refreshPreviewEvent(),d.updateValue()};e.on("remove",function(a,b){-1!==d.criterias.indexOf(b)&&d.criterias.splice(d.criterias.indexOf(b),1),g(a,b)}),e.on("remove-clear",g),e.on("remove-operator",g),e.on("remove-value",g),e.on("index-changed",g),e.on("operator-changed",g),e.on("create-criteria",g),e.on("create-operator",g),e.on("create-value",g),e.on("value-changed",g),d.criterias.push(e)},createSort:function(){var b=this,c=a('[id$="-sort_on"]').filter('[id^="formfield-"]'),d=a('[id$="-sort_reversed"]').filter('[id^="formfield-"]');a("<span/>").addClass(b.options.classSortLabelName).html(b.options.sorttxt).appendTo(b.$sortWrapper),b.$sortOn=a("<select/>").attr("name","sort_on").appendTo(b.$sortWrapper).change(function(){b.refreshPreviewEvent.call(b),a('[id$="sort_on"]',c).val(a(this).val())}),b.$sortOn.append(a('<option value="">No sorting</option>'));for(var e in b.options.sortable_indexes)b.$sortOn.append(a("<option/>").attr("value",e).html(b.options.indexes[e].title));if(b.$sortOn.patternSelect2({width:150}),b.$sortOrder=a("<input type='checkbox' />").attr("name","sort_reversed:boolean").change(function(){b.refreshPreviewEvent.call(b),"checked"===a(this).attr("checked")?a('.option input[type="checkbox"]',d).attr("checked","checked"):a('.option input[type="checkbox"]',d).removeAttr("checked")}),a("<span/>").addClass(b.options.classSortReverseName).appendTo(b.$sortWrapper).append(b.$sortOrder).append(a("<span/>").html(b.options.reversetxt).addClass(b.options.classSortReverseLabelName)),c.length>=1&&d.length>=1){var f="checked"===a('.option input[type="checkbox"]',d).attr("checked"),g=a('[id$="-sort_on"]',c).val();f&&b.$sortOrder.attr("checked","checked"),b.$sortOn.select2("val",g),a(c).hide(),a(d).hide()}},refreshPreviewEvent:function(){var b=this;if(b.options.showPreviews){"undefined"!=typeof b._preview_xhr&&b._preview_xhr.abort(),"undefined"!=typeof b.$previewPane&&b.$previewPane.remove();var c,d=[];if(a.each(b.criterias,function(a,b){c=b.buildQueryPart(),""!==c&&d.push(b.buildQueryPart())}),b.$previewPane=a("<div/>").addClass(b.options.classPreviewName).appendTo(b.$previewWrapper),d.length<=0)return a("<div/>").addClass(b.options.classPreviewCountWrapperName).html("No results to preview").prependTo(b.$previewPane),void 0;d.push("sort_on="+b.$sortOn.val());var e=b.$sortOrder.attr("checked");"checked"===e&&d.push("sort_order=reverse"),b._preview_xhr=a.get(b.options.previewURL+"?"+d.join("&")).done(function(c){a("<div/>").addClass(b.options.classPreviewResultsWrapperName).html(c).appendTo(b.$previewPane)})}},updateValue:function(){var b=this,c=[];a.each(b.criterias,function(a,b){var d=b.getJSONListStr();""!==d&&c.push(d)});var d=(b.$el.val(),"["+c.join(",")+"]");b.$el.val(d),b.$el.trigger("change")}});return g});