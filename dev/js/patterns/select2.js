define(["jquery","mockup-patterns-base","select2","jquery.event.drag","jquery.event.drop"],function(a,b){"use strict";var c=b.extend({name:"select2",defaults:{separator:","},initializeValueMap:function(){var b=this;b.options.initvaluemap&&(b.options.id=function(a){return a.id},b.options.initSelection=function(c,d){var e=[],f=c.val(),g=b.options.initvaluemap;"string"==typeof b.options.initvaluemap&&""!==b.options.initvaluemap&&("{"===b.options.initvaluemap[0]?g=JSON.parse(b.options.initvaluemap):(g={},a(b.options.initvaluemap.split(b.options.separator)).each(function(){var a=this.split(":"),b=a[0],c=a[1];g[b]=c}))),a(f.split(b.options.separator)).each(function(){var a=this;g[this]&&(a=g[this]),e.push({id:this,text:a})}),d(e)})},initializeTags:function(){var a=this;a.options.tags&&"string"==typeof a.options.tags&&(a.options.tags="["===a.options.tags.substr(0,1)?JSON.parse(a.options.tags):a.options.tags.split(a.options.separator))},initializeOrdering:function(){var b=this;if(b.options.orderable){var c=function(a){return a?a.text:void 0};b.options.formatSelection&&(c=b.options.formatSelection),b.options.formatSelection=function(d,e){return e.parents("li").drag("start",function(){a(this).addClass("select2-choice-dragging"),b.$el.select2("onSortStart"),a.drop({tolerance:function(b,c,d){var e=b.pageY>d.top+d.height/2;return a.data(d.elem,"drop+reorder",e?"insertAfter":"insertBefore"),this.contains(d,[b.pageX,b.pageY])}})}).drag(function(b,c){var d=c.drop[0],e=a.data(d||{},"drop+reorder");!d||d==c.current&&e==c.method||(a(this)[e](d),c.current=d,c.method=e,c.update())}).drag("end",function(){a(this).removeClass("select2-choice-dragging"),b.$el.select2("onSortEnd")}).drop("init",function(a,b){return this==b.drag?!1:!0}),c(d,e)}}},initializeSelect2:function(){var a=this;a.$el.select2(a.options),a.$select2=a.$el.parent().find(".select2-container"),a.$el.parent().off("close.modal.patterns"),a.options.orderable&&a.$select2.addClass("select2-orderable")},init:function(){var b=this;if(b.options.ajax||b.options.ajaxvocabulary){b.options.ajaxvocabulary&&(b.options.multiple=!0,b.options.ajax=b.options.ajax||{},b.options.ajax.url=b.options.ajaxvocabulary,b.options.initSelection=function(c,d){var e=[],f=c.val();a(f.split(b.options.separator)).each(function(){e.push({id:this,text:this})}),d(e)});var c="";b.options.ajax=a.extend({quietMillis:300,data:function(a,b){return c=a,{query:a,page_limit:10,page:b}},results:function(d){var e=d.results;if(b.options.ajaxvocabulary){var f=[];a.each(d.results,function(a,b){f.push(b.id)}),e=[],""!==c&&-1===a.inArray(c,f)&&e.push({id:c,text:c}),a.each(d.results,function(a,b){e.push(b)})}return{results:e}}},b.options.ajax)}b.initializeValueMap(),b.initializeTags(),b.initializeOrdering(),b.initializeSelect2()}});return c});