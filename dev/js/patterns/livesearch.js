define(["jquery","underscore","mockup-patterns-base","mockup-patterns-toggle","mockup-patterns-select2","mockup-patterns-queryhelper"],function(a,b,c,d,e,f){"use strict";var g=c.extend({name:"livesearch",timeout:null,blurTimout:null,$results:null,$input:null,$toggle:null,cache:{},currentTerm:null,renderedTerm:"",results:"",index:null,testTarget:null,defaults:{url:null,dataType:"json",delay:200,blurDelay:200,highlight:"pat-livesearch-highlight",minimumInputLength:3,toggleTarget:".pat-livesearch-container",toggleClass:"show",positionToggleWithInput:!0,resultsTarget:".pat-livesearch-results",input:".pat-livesearch-input",resultsContainerTemplate:"<ul></ul>",resultsContainerTemplateSelector:null,resultsAppendTo:"ul",resultSelector:".pat-livesearch-result",resultTemplate:'<li class="pat-livesearch-result pat-livesearch-type-<%= Type %>"><a class="pat-livesearch-result-title" href="<%= getURL %>"><%= Title %></a><p class="pat-livesearch-result-desc"><%= Description %></p></li>',resultTemplateSelector:null,helpTemplate:'<div class="pat-livesearch-help"><%= help %></div>',helpTemplateSelector:null,typeMoreTemplate:'Type <%= more %> more character<%= more === 1 ? "" : "s" %> to search.',typeMoreTemplateSelector:null,noResultsTemplate:"No results found.",noResultsTemplateSelector:null,searchingTemplate:"Searching...",searchingTemplateSelector:null,isTest:!1,setPosition:function(){var a=this;if(a.options.positionToggleWithInput){var b=a.$input.position().top+a.$input.outerHeight();a.$toggle.css({top:b+"px"})}}},init:function(){var b=this;b.query=new f(b.$el,a.extend(!0,{},b.options,{basePattern:b})),this.$results=a(b.options.resultsTarget,b.$el),b.query.valid||a.error("No url provided for livesearch results "+b.$el),b.query.valid?b.options.ajax=b.query.selectAjax():b.options.tags=[],b.$input=a(b.options.input,b.$el),b.$input.length<1&&a.error("Input element not found "+b.$el),b.$input.on("focus.livesearch.patterns",function(){window.clearInterval(b.blurTimeout),b.show()}),b.$input.on("blur.livesearch.patterns",function(){b.blurTimeout=window.setInterval(function(){b.hide(),window.clearInterval(b.blurTimeout)},b.options.blurDelay)}),b.options.toggleTarget&&(b.$toggle=a(b.options.toggleTarget,b.$el),b.$toggle.length&&(a("html").on("click.livesearch.patterns",function(){b.hide()}),b.$toggle.on("click.livesearch.patterns",function(a){a.stopPropagation(),window.clearInterval(b.blurTimeout)}),b.$input.on("click.livesearch.patterns",function(a){a.stopPropagation()}))),b.$input.on("keyup keydown",function(a){return b._handler(a)}),b.on("showing.livesearch.patterns",function(a){b.render(a)}),b.on("searched.livesearch.patterns",function(a){b.render(a)}),b.on("render.livesearch.patterns",function(a){b.render(a)}),b.on("searching.livesearch.patterns",function(a){b.render(a)}),b.on("cachedresult.livesearch.patterns",function(a){b.render(a)})},search:function(){var b=this,c=b.currentTerm;if(b.trigger("searching"),void 0!==b.cache[c])return b.trigger("cachedresult"),void 0;var d=b.options.ajax.data(c,1);window.clearInterval(b.timeout),a.get(b.options.ajax.url,a.param(d),function(a){var d=b.options.dataType;"json"===d?void 0!==a.results?b.cache[c]=a.results:console.log("error from server returning result"):"html"===d&&(void 0!==a.results?b.cache[c]=a.results:console.log("error from server returning result")),b.trigger("searched")})},applyTemplate:function(c,d){var e,f=this;return f.options[c+"TemplateSelector"]?(e=a(f.options[c+"TemplateSelector"]).html(),e||(e=f.options[c+"Template"])):e=f.options[c+"Template"],b.template(e,d)},getCache:function(){var a=this,b=[];return null!==a.currentTerm&&a.currentTerm.length>=a.options.minimumInputLength&&void 0!==a.cache[a.currentTerm]&&(b=a.cache[a.currentTerm]),b},renderHelp:function(a,b){var c=this,d=c.applyTemplate(a,b);return c.applyTemplate("help",{help:d})},renderJsonResults:function(b){var c=this,d="";return b.length>0?a.each(b,function(a,b){d+=c.applyTemplate("result",b)}):d=c.renderHelp("noResults",{}),d},renderhtmlResults:function(a){return a},render:function(b){var c=this;if(c.currentTerm!==c.renderedTerm){var d=a("<div />");if("searching"===b.type)d.html(c.renderHelp("searching",{}));else if(c.renderedTerm=c.currentTerm,null===c.currentTerm||c.currentTerm.length<c.options.minimumInputLength){var e=null!==c.currentTerm?c.options.minimumInputLength-c.currentTerm.length:c.options.minimumInputLength;d.html(c.renderHelp("typeMore",{more:e}))}else{var f=c.getCache();d.html(c.applyTemplate("resultsContainer",c));var g=d.find(c.options.resultsAppendTo);0===g.length&&(g=d),f?"json"===c.options.dataType?g.append(c.renderJsonResults(f)):"html"===c.options.dataType&&g.append(c.renderHtmlResults(f)):d.html(c.renderHelp("noResults",{}))}c.options.setPosition.apply(c),c.$results.html(d),c.trigger("rendered")}},show:function(){var a=this;a.trigger("showing"),a.$toggle&&a.$toggle.addClass(a.options.toggleClass),a.trigger("shown")},hide:function(){var b=this,c=b.options.highlight;b.trigger("hiding"),b.$toggle&&b.$toggle.removeClass(b.options.toggleClass),a("."+c,b.$results).removeClass(c),b.trigger("hidden")},items:function(){return this.$results.find(this.options.resultSelector)},_keyUp:function(){var b=this,c=b.options.highlight,d=a("."+c,b.$results);d.length>0&&d.prev().length>0&&(d.removeClass(c),d=d.prev().addClass(c))},_keyDown:function(){var b=this,c=b.options.highlight,d=a("."+c,b.$results);0===d.length?d=b.items().first().addClass(c):d.next().length>0&&(d.removeClass(c),d=d.next().addClass(c))},_keyEscape:function(){this.$input.trigger("blur")},_keyEnter:function(){var a=this,b=a.options.highlight,c=a.$results.find("."+b).find("a").attr("href");return a.options.isTest?(a.testTarget=c,void 0):(window.location=c,void 0)},_handler:function(a){var b=this;if(window.clearTimeout(b.timeout),"keyup"===a.type)switch(a.keyCode){case 13:return b._keyEnter(),!1;case 27:b._keyEscape();break;case 38:break;case 40:break;case 37:break;case 39:break;default:b.currentTerm=b.$input.val(),b.$input.val().length>=b.options.minimumInputLength?b.timeout=window.setInterval(function(){try{b.search()}catch(a){console.log("error trying to search"),window.clearInterval(b.timeout)}},b.options.delay):b.trigger("render")}else if("keydown"===a.type)switch(a.keyCode){case 38:return b._keyUp(),!1;case 40:return b._keyDown(),!1}}});return g});