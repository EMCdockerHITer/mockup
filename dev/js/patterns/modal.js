define(["jquery","underscore","mockup-patterns-base","mockup-patterns-backdrop","mockup-registry","jquery.form"],function(a,b,c,d,e){"use strict";var f=c.extend({name:"modal",createModal:null,$model:null,defaults:{width:"",height:"",margin:function(){return 20},position:"center middle",triggers:[],backdrop:"body",backdropOptions:{zIndex:"1040",opacity:"0.8",klass:"backdrop",klassActive:"backdrop-active",closeOnEsc:!0,closeOnClick:!0},templateOptions:{title:null,titleSelector:"h1:first",buttons:'.formControls > input[type="submit"]',automaticallyAddButtonActions:!0,loadLinksWithinModal:!0,content:"#content",klass:"modal",klassHeader:"modal-header",klassBody:"modal-body",klassFooter:"modal-footer",klassWrapper:"modal-wrapper",klassWrapperInner:"modal-wrapper-inner",klassLoading:"modal-loading",klassActive:"active",klassPrepend:"",klassContent:"",prependContent:".portalMessage",template:'<div class="<%= options.klass %>">  <div class="<%= options.klassHeader %>">    <a class="close">&times;</a>    <% if (title) { %><h3><%= title %></h3><% } %>  </div>  <div class="<%= options.klassBody %>">    <div class="<%= options.klassPrepend %>"><%= prepend %></div>     <div class="<%= options.klassContent %>"><%= content %></div>  </div>  <div class="<%= options.klassFooter %>">     <%= buttons %>   </div></div>',actions:{},actionsOptions:{eventType:"click",target:null,ajaxUrl:null,modalFunction:null,isForm:!1,timeout:5e3,displayInModal:!0,reloadWindowOnClose:!0,error:".portalMessage.error",loading:'<div class="progress progress-striped active">  <div class="bar" style="width: 100%;"></div></div>',onSuccess:null,onError:null,onFormError:null,onTimeout:null,redirectOnResponse:!1,redirectToUrl:function(b,c){var d=a(a(/<base[^>]*>((.|[\n\r])*)<\/base>/im.exec(c)[0].replace("<base","<div").replace("</base>","</div>"))[0]);return d.attr("href")}},form:function(b,c){var d=this,e=d.$modal,f=d.options.templateOptions;f.automaticallyAddButtonActions&&(b[f.buttons]={}),f.loadLinksWithinModal&&(b.a={}),a.each(b,function(b,f){f=a.extend({},c,f),a(b,a(".modal-body",e)).each(function(){var b=a(this);b.on(f.eventType,function(c){c.stopPropagation(),c.preventDefault(),d.showLoading(!1),null!==f.modalFunction?d[f.modalFunction]():a.nodeName(b[0],"input")||a.nodeName(b[0],"button")||f.isForm===!0?d.options.handleFormAction.apply(d,[b,f]):(null!==f.ajaxUrl||a.nodeName(b[0],"a"))&&d.options.handleLinkAction.apply(d,[b,f])})})})}},handleFormAction:function(b,c){var d=this,e={};e[b.attr("name")]=b.attr("value");var f;f=a.nodeName(b[0],"form")?b:b.parents("form:not(.disableAutoSubmit)");var g;g=null!==c.ajaxUrl?"function"==typeof c.ajaxUrl?c.ajaxUrl.apply(d,[b,c]):c.ajaxUrl:b.parents("form").attr("action"),f.on("submit",function(a){a.preventDefault()}),f.trigger("submit"),f.ajaxSubmit({timeout:c.timeout,data:e,url:g,error:function(a,b,e){"timeout"===b&&c.onTimeout?c.onTimeout.apply(d,a,e):c.onError?c.onError(a,b,e):console.log("error happened do something"),d.trigger("formActionError",[a,b,e])},success:function(e,f,g,h){return 0!==a(c.error,e).size()?(c.onFormError?c.onFormError(d,e,f,g,h):d.redraw(e),void 0):(c.redirectOnResponse===!0&&(window.parent.location.href="function"==typeof c.redirectToUrl?c.redirectToUrl.apply(d,[b,e,c]):c.redirectToUrl),c.onSuccess&&c.onSuccess(d,e,f,g,h),c.displayInModal===!0?d.redraw(e):(b.trigger("destroy.modal.patterns"),c.reloadWindowOnClose?d.reloadWindow():d.hide()),d.trigger("formActionSuccess",[e,f,g,h]),void 0)}})},handleLinkAction:function(b,c){var d,e=this;return d=c.ajaxUrl?"function"==typeof c.ajaxUrl?c.ajaxUrl.apply(e,[b,c]):c.ajaxUrl:b.attr("href"),c.displayInModal===!1?(window.parent.location.href=d,void 0):(a.ajax({url:d,error:function(a,b,d){"timeout"===b&&c.onTimeout?c.onTimeout(e.$modal,a,d):c.onError?c.onError(a,b,d):console.log("error happened do something"),e.$loading.hide(),e.trigger("linkActionError",[a,b,d])},success:function(a,b,d){e.redraw(a),c.onSuccess&&c.onSuccess(e,a,b,d),e.$loading.hide(),e.trigger("linkActionSuccess",[a,b,d])}}),void 0)},render:function(c){var d=this;if(d.trigger("before-render"),d.$raw){var e=d.$raw.clone(),f={title:"",prepend:"<div />",content:"",buttons:'<div class="pat-modal-buttons"></div>',options:c};if(null===c.title){var g=a(c.titleSelector,e);f.title=g.html(),a(c.titleSelector,e).remove()}else f.title=c.title;c.prependContent&&(f.prepend=a("<div />").append(a(c.prependContent,e).clone()).html(),a(c.prependContent,e).remove()),f.content=c.content?a(c.content,e).html():e.html(),d.$modal=a(b.template(d.options.templateOptions.template,f)),a(c.buttons,d.$modal).each(function(){var b=a(this);b.on("click",function(a){a.stopPropagation(),a.preventDefault()}).clone().appendTo(a(".pat-modal-buttons",d.$modal)).off("click").on("click",function(a){a.stopPropagation(),a.preventDefault(),b.trigger("click")}),b.hide()}),a(".modal-header > a.close",d.$modal).off("click").on("click",function(b){b.stopPropagation(),b.preventDefault(),a(b.target).trigger("destroy.modal.patterns")}),a(".row",d.$modal).removeClass("row"),c.form&&c.form.apply(d,[c.actions,c.actionsOptions]),d.$modal.addClass(d.options.templateOptions.klass).on("click",function(b){b.stopPropagation(),a.nodeName(b.target,"a")&&b.preventDefault()}).on("destroy.modal.patterns",function(a){a.stopPropagation(),d.hide()}).on("resize.modal.patterns",function(a){a.stopPropagation(),a.preventDefault(),d.positionModal()}).appendTo(d.$wrapperInner),d.$modal.data("pattern-"+d.name,d),d.trigger("after-render")}}},reloadWindow:function(){window.parent.location.reload()},init:function(){var b=this;b.backdrop=new d(b.$el.parents(b.options.backdrop),b.options.backdropOptions),b.$wrapper=a("> ."+b.options.templateOptions.klassWrapper,b.backdrop.$el),0===b.$wrapper.size()&&(b.$wrapper=a("<div/>").hide().css({"z-index":parseInt(b.options.backdropOptions.zIndex,10)+1,"overflow-y":"auto",position:"fixed",height:"100%",width:"100%",bottom:"0",left:"0",right:"0",top:"0"}).addClass(b.options.templateOptions.klassWrapper).insertBefore(b.backdrop.$backdrop).on("click",function(a){a.stopPropagation(),a.preventDefault(),b.options.backdropOptions.closeOnClick&&b.backdrop.hide()})),b.backdrop.on("hidden",function(){void 0!==b.$modal&&b.$modal.hasClass(b.options.klassActive)&&b.hide()}),b.options.backdropOptions.closeOnEsc===!0&&a(document).on("keydown",function(a){b.$el.is("."+b.options.templateOptions.klassActive)&&27===a.keyCode&&b.hide()}),b.$wrapperInner=a("> ."+b.options.templateOptions.klassWrapperInner,b.$wrapper),0===b.$wrapperInner.size()&&(b.$wrapperInner=a("<div/>").addClass(b.options.klassWrapperInner).css({position:"absolute",bottom:"0",left:"0",right:"0",top:"0"}).appendTo(b.$wrapper)),b.$loading=a("> ."+b.options.templateOptions.klassLoading,b.$wrapperInner),0===b.$loading.size()&&(b.$loading=a("<div/>").hide().addClass(b.options.templateOptions.klassLoading).appendTo(b.$wrapperInner)),a(window.parent).resize(function(){b.positionModal()}),b.options.triggers&&a.each(b.options.triggers,function(c,d){var e=d.substring(0,d.indexOf(" ")),f=d.substring(d.indexOf(" "),d.length);a(f||b.$el).on(e,function(a){a.stopPropagation(),a.preventDefault(),b.show()})}),b.$el.is("a")&&(b.$el.attr("href")&&(b.options.target||"#"!==b.$el.attr("href").substr(0,1)||(b.options.target=b.$el.attr("href"),b.options.templateOptions.content=""),b.options.ajaxUrl||"#"===b.$el.attr("href").substr(0,1)||(b.options.ajaxUrl=b.$el.attr("href"))),b.$el.on("click",function(a){a.stopPropagation(),a.preventDefault(),b.show()})),b.initModal()},showLoading:function(a){var b=this;void 0===a&&(a=!0),b.backdrop.closeOnClick=a,b.backdrop.closeOnEsc=a,b.backdrop.init(),b.$wrapper.parent().css("overflow","hidden"),b.$wrapper.show(),b.backdrop.show(),b.$loading.show(),b.positionLoading()},createAjaxModal:function(){var b=this;b.trigger("before-ajax"),b.showLoading(),b.ajaxXHR=a.ajax({url:b.options.ajaxUrl,type:b.options.ajaxType}).done(function(c,d,e){b.ajaxXHR=void 0,b.$loading.hide(),b.$raw=a("<div />").append(a(a(/<body[^>]*>((.|[\n\r])*)<\/body>/im.exec(c)[0].replace("<body","<div").replace("</body>","</div>"))[0])),b.trigger("after-ajax",b,d,e),b._show()})},createTargetModal:function(){var b=this;b.$raw=a(b.options.target).clone(),b._show()},createBasicModal:function(){var b=this;b.$raw=a("<div/>").html(b.$el.clone()),b._show()},createHtmlModal:function(){var b=this,c=a(b.options.html);b.$raw=c,b._show()},initModal:function(){var a=this;a.createModal=a.options.ajaxUrl?a.createAjaxModal:a.options.target?a.createTargetModal:a.options.html?a.createHtmlModal:a.createBasicModal},positionLoading:function(){var a=this;a.$loading.css({"margin-left":a.$wrapper.width()/2-a.$loading.width()/2,"margin-top":a.$wrapper.height()/2-a.$loading.height()/2,position:"absolute",bottom:"0",left:"0",right:"0",top:"0"})},findPosition:function(a,b,c,d,e,f,g){var h,i,j,k,l={};return k=j=h=j="auto","left"===a?(j=c+"px",d>f&&(j="0px"),l.left=j):"right"===a?(k=c+"px",d>f&&(k="0px"),l.right=k,l.left="auto"):(j=f/2-d/2-c+"px",d>f&&(j="0px"),l.left=j),"top"===b?(h=c+"px",e>g&&(h="0px"),l.top=h):"bottom"===b?(i=c+"px",e>g&&(i="0px"),l.bottom=i,l.top="auto"):(h=g/2-e/2-c+"px",e>g&&(h="0px"),l.top=h),l},positionModal:function(){var b=this;if(null!==b.$modal&&void 0!==b.$modal){b.$modal.removeAttr("style"),b.$wrapper.parent().is("body")&&b.$wrapper.height(a(window.parent).height());var c="function"==typeof b.options.margin?b.options.margin():b.options.margin;b.$modal.css({padding:"0",margin:c,width:b.options.width,height:b.options.height,position:"absolute"});var d=b.options.position.split(" "),e=d[0],f=d[1],g=b.$modal.outerWidth(!0),h=b.$modal.outerHeight(!0),i=b.$wrapperInner.width(),j=b.$wrapperInner.height(),k=b.findPosition(e,f,c,g,h,i,j);for(var l in k)b.$modal.css(l,k[l])}},render:function(a){var b=this;b.trigger("render"),b.options.render.apply(b,[a]),b.trigger("rendered")},show:function(){var a=this;a.createModal()},_show:function(){var b=this;b.render.apply(b,[b.options.templateOptions]),b.trigger("show"),b.backdrop.show(),b.$wrapper.show(),b.$loading.hide(),b.$wrapper.parent().css("overflow","hidden"),b.$el.addClass(b.options.templateOptions.klassActive),b.$modal.addClass(b.options.templateOptions.klassActive),e.scan(b.$modal),b.positionModal(),a("img",b.$modal).load(function(){b.positionModal()}),a(window.parent).on("resize.modal.patterns",function(){b.positionModal()}),b.trigger("shown")},hide:function(){var b=this;b.ajaxXHR&&b.ajaxXHR.abort(),b.trigger("hide"),a(".modal",b.$wrapper).size()<2&&(b.backdrop.hide(),b.$wrapper.hide(),b.$loading.hide(),b.$wrapper.parent().css("overflow","visible")),b.$el.removeClass(b.options.templateOptions.klassActive),void 0!==b.$modal&&(b.$modal.remove(),b.initModal()),a(window.parent).off("resize.modal.patterns"),b.trigger("hidden")},redraw:function(b){var c=this;c.trigger("beforeDraw"),c.$modal.remove(),c.$raw=a("<div />").append(a(a(/<body[^>]*>((.|[\n\r])*)<\/body>/im.exec(b)[0].replace("<body","<div").replace("</body>","</div>"))[0])),c.render.apply(c,[c.options.templateOptions]),c.positionModal(),e.scan(c.$modal),c.trigger("afterDraw")}});return f});