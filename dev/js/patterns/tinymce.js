define(["jquery","mockup-patterns-base","mockup-patterns-relateditems","mockup-patterns-modal","tinymce","mockup-patterns-dropzone","dropzone"],function(a,b,c,d,e,f){"use strict";e.PluginManager.add("plonelink",function(a){a.addButton("plonelink",{icon:"link",tooltip:"Insert/edit link",shortcut:"Ctrl+K",onclick:a.settings.addLinkClicked,stateSelector:"a[href]"}),a.addButton("unlink",{icon:"unlink",tooltip:"Remove link(s)",cmd:"unlink",stateSelector:"a[href]"}),a.addShortcut("Ctrl+K","",a.settings.addLinkClicked),a.addMenuItem("plonelink",{icon:"link",text:"Insert link",shortcut:"Ctrl+K",onclick:a.settings.addLinkClicked,stateSelector:"a[href]",context:"insert",prependToContext:!0})}),e.PluginManager.add("ploneimage",function(a){a.addButton("ploneimage",{icon:"image",tooltip:"Insert/edit image",onclick:a.settings.addImageClicked,stateSelector:"img:not([data-mce-object])"}),a.addMenuItem("ploneimage",{icon:"image",text:"Insert image",onclick:a.settings.addImageClicked,context:"insert",prependToContext:!0})}),e.PluginManager.add("ploneupload",function(a){a.addButton("ploneupload",{icon:"newdocument",tooltip:"Upload file",onclick:a.settings.uploadFileClicked}),a.addMenuItem("ploneupload",{icon:"newdocument",text:"Upload file",onclick:a.settings.uploadFileClicked,context:"insert",prependToContext:!0})});var g=b.extend({name:"uploadmodal",defaults:{text:{uploadHeading:"Upload file",file:"File",uploadBtn:"Upload",uploadLocationWarning:"If you do not select a folder to upload to, the file will be uploaded to the current folder."}},init:function(){var a=this;a.tinypattern=a.options.tinypattern,a.modal=new d(a.$el,{html:'<div><div class="linkModal"><form method="POST" class="disableAutoSubmit" action="'+a.options.upload_url+'" '+'enctype="multipart/form-data">'+"<h1>"+a.options.text.uploadHeading+"</h1>"+'<div class="">'+"<input type='text' name='location' class='pat-relateditems' data-pat-relateditems='"+JSON.stringify(a.options.relatedItems)+"' />"+"</div>"+"<p>"+a.options.text.uploadLocationWarning+"</p>"+'<div class="control-group">'+"<label>"+a.options.text.file+"</label>"+'<div class="controls">'+"<input type='file' name='file' />"+"</div>"+"</div>"+'<input type="submit" class="btn btn-primary" name="upload" value="'+a.options.text.uploadBtn+'" />'+'<iframe id="upload_target" name="upload_target" src="" '+'style="width:0;height:0;border:0px solid #fff;"></iframe>'+"</form>"+"</div>"+"</div>",templateOptions:{content:null,buttons:".btn"}}),a.modal.on("shown",function(b){a.modalShown.apply(a,[b])})},show:function(){this.modal.show()},hide:function(){this.modal.hide()},modalShown:function(){var b=this;b.$uploadBtn=a('input[type="submit"]',b.modal.$modal),b.$form=a("form",b.modal.$modal),b.$iframe=a("iframe",b.modal.$modal),b.$form.on("submit",function(){var c=b.modal.$modal.find('[name="location"]').select2("data");c.length>0&&b.$form.attr("action",c[0].getURL+"/"+b.options.rel_upload_path),b.modal.$loading.show(),b.$iframe.on("load",function(){var c=b.$iframe.contents();b.modal.$loading.hide(),b.hide(),c.length&&c[0].firstChild||b.tinypattern.fileUploadError(),c=a(c[0].body).text(),b.tinypattern.fileUploaded(a.parseJSON(c))}),b.$form[0].target="upload_target"}),b.$uploadBtn.on("click",function(a){a.preventDefault(),b.$form.trigger("submit")})},reinitialize:function(){}}),h=b.extend({name:"linkmodal",defaults:{anchor_selector:"h1,h2,h3",linkTypes:[],initialLinkType:"internal",text:{insertHeading:"Insert Link"}},init:function(){var a=this;a.tinypattern=a.options.tinypattern,a.tiny=a.tinypattern.tiny,a.linkType=a.options.initialLinkType,a.linkTypes=a.options.linkTypes,a.initData(),a.anchor_nodes=[],a.anchor_data=[],a.$_modal=null,a.modal=new d(a.$el,{html:a.generateModalHtml(),templateOptions:{content:null,buttons:".btn"}}),a.modal.on("shown",function(b){a.modalShown.apply(a,[b])}),a.initElements()},generateModalHtml:function(){var a=this;return'<div><div class="linkModal"><h1>'+a.options.text.insertHeading+"</h1>"+a.buildLinkTypeElement()+'<hr style="clear:both" />'+'<div class="internal linkType">'+"<input type='text' name='internal' class='pat-relateditems' data-pat-relateditems='"+JSON.stringify(a.options.relatedItems)+"' value='"+a.uid+"' />"+"</div>"+'<div class="image linkType">'+"<input type='text' name='image' class='pat-relateditems' data-pat-relateditems='"+JSON.stringify(a.options.relatedItems)+"' value='"+a.uid+"' />"+"</div>"+'<div class="control-group external linkType">'+"<label>"+a.options.text.external+"</label>"+'<div class="controls">'+'<input type="text" name="external" value="'+a.external+'" />'+"</div>"+"</div>"+'<div class="control-group email linkType">'+"<label>"+a.options.text.email+"</label>"+'<div class="controls">'+'<input type="text" name="email" value="'+a.email+'" />'+"</div>"+"</div>"+'<div class="control-group email linkType">'+"<label>"+a.options.text.subject+"</label>"+'<div class="controls">'+'<input type="text" name="subject" value="'+a.subject+'" />'+"</div>"+"</div>"+'<div class="control-group anchor linkType">'+"<label>Select an anchor</label>"+'<div class="controls">'+'<select name="anchor" class="pat-select2" data-pat-select2="width:500px" '+'        value="'+a.anchor+'" />'+"</div>"+"</div>"+'<div class="control-group linkType anchor email external internal">'+'<div class="controls">'+a.buildTargetElement()+"</div>"+"</div>"+'<div class="control-group linkType anchor email external internal">'+"<label>"+a.options.text.title+"</label>"+'<div class="controls">'+'<input type="text" name="title" value="'+a.title+'" />'+"</div>"+"</div>"+'<div class="control-group linkType externalImage">'+"<label>"+a.options.text.externalImage+"</label>"+'<div class="controls">'+'<input type="text" name="externalImage" '+'       value="'+a.externalImage+'" />'+"</div>"+"</div>"+'<div class="control-group linkType image externalImage">'+"<label>"+a.options.text.alt+"</label>"+'<div class="controls">'+'<input type="text" name="alt" value="'+a.alt+'" />'+"</div>"+"</div>"+'<div class="control-group linkType image externalImage">'+"<label>"+a.options.text.imageAlign+"</label>"+'<div class="controls">'+a.buildAlignElement()+"</div>"+"</div>"+'<div class="control-group linkType image">'+"<label>"+a.options.text.scale+"</label>"+'<div class="controls">'+a.buildScalesElement()+"</div>"+"</div>"+'<input type="submit" class="btn" name="cancel" value="'+a.options.text.cancelBtn+'" />'+'<input type="submit" class="btn btn-primary" name="insert" value="'+a.options.text.insertBtn+'" />'+"</div>"+"</div>"},isImageMode:function(){return-1!==["image","externalImage"].indexOf(this.linkType)},initElements:function(){var b=this;b.$internal=a('input[name="internal"]',b.modal.$modal),b.$target=a('select[name="target"]',b.modal.$modal),b.$button=a('input[name="insert"]',b.modal.$modal),b.$title=a('input[name="title"]',b.modal.$modal),b.$external=a('input[name="external"]',b.modal.$modal),b.$email=a('input[name="email"]',b.modal.$modal),b.$subject=a('input[name="subject"]',b.modal.$modal),b.$anchor=a('select[name="anchor"]',b.modal.$modal),b.$image=a('input[name="image"]',b.modal.$modal),b.$alt=a('input[name="alt"]',b.modal.$modal),b.$align=a('select[name="align"]',b.modal.$modal),b.$scale=a('select[name="scale"]',b.modal.$modal),b.$externalImage=a('input[name="externalImage"]',b.modal.$modal),b.$linkTypes=a(".linkTypes",b.modal.$modal);var c=b.$linkTypes.find('input[value="'+b.linkType+'"]');c.length>0&&(c[0].checked=!0),b.populateAnchorList(),b.activateLinkTypeElements()},activateLinkTypeElements:function(){var b=this;a(".linkType",b.modal.$modal).hide(),a("."+b.linkType).show()},getLinkUrl:function(){var a,b=this;if("internal"===b.linkType){if(a=b.$internal.select2("data"))return"object"==typeof a&&(a=a[0]),"resolveuid/"+a.UID}else{if("external"===b.linkType)return b.$external.val();if("email"===b.linkType){if(a=b.$email.val()){var c=b.$subject.val(),d="mailto:"+b.$email.val();return c&&(d+="?subject="+c),d}}else if("anchor"===b.linkType){if(a=b.$anchor.select2("val")){var e=parseInt(a,10),f=b.anchor_nodes[e],g=b.anchor_data[e];return g.newAnchor&&(f.innerHTML='<a name="'+g.name+'" class="mce-item-anchor"></a>'+f.innerHTML),"#"+g.name}}else if("image"===b.linkType){if(a=b.$image.select2("data")){"object"==typeof a&&(a=a[0]);var h="resolveuid/"+a.UID,i=b.$scale.val();return i&&(h+="/@@images/image/"+i),h}}else if("externalImage"===b.linkType&&(a=b.$externalImage.val()))return a}return null},getAnchorIndex:function(a){for(var b=this,c=0;c<b.anchor_data.length;c+=1){var d=b.anchor_data[c];if(d.name===a)return c}return 0},updateAnchor:function(a){var b=this,c=b.$target.val(),d=b.$title.val();b.text!==b.initialText?b.anchorElm?(b.tiny.focus(),b.anchorElm.innerHTML=b.text,b.dom.setAttribs(b.anchorElm,{href:a,target:c?c:null,rel:b.rel?b.rel:null,title:d?d:null}),b.selection.select(b.anchorElm)):b.tiny.insertContent(b.dom.createHTML("a",{href:a,target:c?c:null,rel:b.rel?b.rel:null,title:d?d:null},b.text)):b.tiny.execCommand("mceInsertLink",!1,{href:a,target:c,rel:b.rel?b.rel:null,title:d?d:null})},updateImage:function(a){function b(a){a.onload=a.onerror=function(){a.onload=a.onerror=null,c.tiny.selection.select(a),c.tiny.nodeChanged()}}var c=this,d={src:a,alt:c.$alt.val(),"class":"image-"+c.$align.val()};c.imgElm&&!c.imgElm.getAttribute("data-mce-object")?(d.width=c.dom.getAttrib(c.imgElm,"width"),d.height=c.dom.getAttrib(c.imgElm,"height")):c.imgElm=null,c.imgElm?c.dom.setAttribs(c.imgElm,d):(d.id="__mcenew",c.tiny.insertContent(c.dom.createHTML("img",d)),c.imgElm=c.dom.get("__mcenew"),c.dom.setAttrib(c.imgElm,"id",null)),b(c.imgElm)},modalShown:function(){var b=this;b.initElements(),b.$button.off("click").on("click",function(){var a=b.getLinkUrl();a&&(b.isImageMode()?b.updateImage(a):b.updateAnchor(a),b.hide())}),a('input[name="cancel"]',b.modal.$modal).click(function(a){a.preventDefault(),b.hide()}),a(".linkTypes input:radio",b.modal.$modal).change(function(){b.linkType=a(this).val(),b.activateLinkTypeElements()}),b.setupDropzone()},setupDropzone:function(){var b=this;b.options.upload_url&&(b.dropzone=new f(b.modal.$modal,{klass:"tinymce-dropzone",clickable:!1,url:b.options.upload_url,wrap:"inner",autoCleanResults:!0,success:function(c,d){b.tinypattern.fileUploaded(a.parseJSON(d)),b.hide()}}))},populateAnchorList:function(){var b=this;b.$anchor.find("option").remove(),b.anchor_nodes=[],b.anchor_data=[];var c,d,e,f,g=b.tiny.dom.select("a.mceItemAnchor,img.mceItemAnchor,a.mce-item-anchor,img.mce-item-anchor");for(d=0;d<g.length;d+=1)c=g[d],e=b.tiny.dom.getAttrib(c,"name"),e||(e=b.tiny.dom.getAttrib(c,"id")),""!==e&&(b.anchor_nodes.push(c),b.anchor_data.push({name:e,title:e}));if(g=b.tiny.dom.select(b.options.anchor_selector),g.length>0)for(d=0;d<g.length;d+=1)if(c=g[d],f=a(c).text().replace(/^\s+|\s+$/g,""),""!==f){e=f.toLowerCase().substring(0,1024),e=e.replace(/[^a-z0-9]/g,"-");var h=!1;for(d=0;d<b.anchor_nodes.length;d+=1){var i=b.anchor_data[d];if(i.name===e){h=!0,i.title=f;break}}h||(b.anchor_data.push({name:e,title:f,newAnchor:!0}),b.anchor_nodes.push(c))}if(b.anchor_nodes.length>0)for(d=0;d<b.anchor_data.length;d+=1){var j=b.anchor_data[d];b.$anchor.append("<option value='"+d+"'>"+j.title+"</option>")}else b.$anchor.append("<option>No anchors found..</option>")},show:function(){this.modal.show()},hide:function(){this.modal.hide()},initData:function(){var a=this;if(a.dom=a.tiny.dom,a.selection=a.tiny.selection,a.external=a.externalImage=a.email=a.subject=a.anchor=a.scale=a.align="",a.tiny.focus(),a.selectedElm=a.imgElm=a.selection.getNode(),a.anchorElm=a.dom.getParent(a.selectedElm,"a[href]"),a.anchorElm&&a.selection.select(a.anchorElm),"IMG"===a.imgElm.nodeName&&a.isImageMode()||(a.imgElm=null),a.text=a.initialText=a.selection.getContent({format:"text"}),a.href=a.anchorElm?a.dom.getAttrib(a.anchorElm,"href"):"",a.target=a.anchorElm?a.dom.getAttrib(a.anchorElm,"target"):"",a.rel=a.anchorElm?a.dom.getAttrib(a.anchorElm,"rel"):"",a.title=a.anchorElm?a.dom.getAttrib(a.anchorElm,"title"):"",a.src=a.imgElm?a.dom.getAttrib(a.imgElm,"src"):"",a.klass=a.imgElm?a.dom.getAttrib(a.imgElm,"class"):"",a.alt=a.imgElm?a.dom.getAttrib(a.imgElm,"alt"):"",a.imgElm&&"IMG"===a.imgElm.nodeName&&(a.text=a.initialText=" "),a.uid="",a.href&&!a.isImageMode())if(-1!==a.href.indexOf("resolveuid/"))a.uid=a.href.replace("resolveuid/",""),a.linkType="internal";else if(-1!==a.href.indexOf("mailto:")){a.linkType="email";var b=a.href.substring("mailto:".length,a.href.length),c=b.split("?subject=");a.email=c[0],c.length>1&&(a.subject=decodeURIComponent(c[1]))}else"#"===a.href[0]?(a.linkType="anchor",a.anchor=a.getAnchorIndex(a.href.substring(1))):(a.linkType="external",a.external=a.href);else if(a.src){-1!==a.src.indexOf("resolveuid/")?(a.linkType="image",a.uid=a.src.replace("resolveuid/",""),-1!==a.uid.indexOf("@@images/image/")?a.scale=a.uid.split("@@images/image/")[1]:-1!==a.uid.indexOf("/image_")&&(a.scale=a.uid.split("/image_")[1]),a.uid=a.uid.split("/@@images")[0].split("/image_")[0]):(a.linkType="externalImage",a.externalImage=a.src);for(var d=a.klass.split(" "),e=0;e<d.length;e+=1){var f=d[e];-1!==f.indexOf("image-")&&(a.align=f.replace("image-",""))}}},buildAlignElement:function(){for(var a=this,b=["inline","right","left"],c='<select name="align">',d=0;d<b.length;d+=1){var e=b[d];c+='<option value="'+e+'" ',e===a.align&&(c+='selected="selected"'),c+=">"+e.charAt(0).toUpperCase()+e.slice(1)+"</option>"}return c+="</select>"},buildScalesElement:function(){for(var a=this,b='<select name="scale"><option value="">Original</option>',c=a.options.scales.split(","),d=0;d<c.length;d+=1){var e=c[d].split(":");b+='<option value="'+e[1]+'" ',e[1]===a.scale&&(b+='selected="selected" '),b+=">"+e[0]+"</option>"}return b+="</select>"},buildLinkTypeElement:function(){for(var a=this,b='<div class="linkTypes">',c=0;c<a.linkTypes.length;c+=1){var d=a.linkTypes[c];b+='<label><input name="linktype" type="radio"  value="'+d+'" />'+a.options.text[d]+"</label>"}return b+="</div>"},buildTargetElement:function(){for(var a=this,b='<select name="target">',c=0;c<a.options.targetList.length;c+=1){var d=a.options.targetList[c];b+='<option value="'+d.value+'" ',d.value===a.target&&(b+='selected="selected"'),b+=">"+d.text+"</option>"}return b+="</select>"},setSelectElement:function(a,b){a.find("option:selected").attr("selected",""),b&&a.find('option[value="'+b+'"]').attr("selected","true")},reinitialize:function(){var a=this;a.initData(),a.modal.options.html=a.generateModalHtml()}}),i=b.extend({name:"tinymce",defaults:{relatedItems:{attributes:["UID","Title","Description","getURL","Type","path","ModificationDate"],batchSize:20,basePath:"/",ajaxvocabulary:null,width:500,maximumSelectionSize:1,placeholder:"Search for item on site..."},text:{insertBtn:"Insert",cancelBtn:"Cancel",insertHeading:"Insert link",title:"Title",internal:"Internal",external:"External",email:"Email",anchor:"Anchor",subject:"Subject",image:"Image",imageAlign:"Align",scale:"Size",alt:"Alternative Text",externalImage:"External Image URI"},scales:"Listing (16x16):listing,Icon (32x32):icon,Tile (64x64):tile,Thumb (128x128):thumb,Mini (200x200):mini,Preview (400x400):preview,Large (768x768):large",targetList:[{text:"Open in this window / frame",value:""},{text:"Open in new window",value:"_blank"},{text:"Open in parent window / frame",value:"_parent"},{text:"Open in top frame (replaces all frames)",value:"_top"}],imageTypes:"Image",folderTypes:"Folder,Plone Site",linkableTypes:"Document,Event,File,Folder,Image,News Item,Topic",tiny:{plugins:["advlist autolink lists charmap print preview anchor ploneupload","searchreplace visualblocks code fullscreen autoresize","insertdatetime media table contextmenu paste plonelink ploneimage"],menubar:"edit table format tools view insert",toolbar:"undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | unlink plonelink ploneimage | ploneupload",autoresize_max_height:1500},rel_upload_path:null,folder_url:null},uploadFileClicked:function(){var b=this;if(null===b.uploadModal){var c=a("<div/>").insertAfter(b.$el);b.uploadModal=new g(c,a.extend(!0,{},b.options,{tinypattern:b,relatedItems:{baseCriteria:[{i:"Type",o:"plone.app.querystring.operation.list.contains",v:b.options.folderTypes.split(",")}],placeholder:"Select a folder to upload to..."}})),b.uploadModal.show()}else b.uploadModal.reinitialize(),b.uploadModal.show()},addLinkClicked:function(){var b=this;if(null===b.linkModal){var c=a("<div/>").insertAfter(b.$el);b.linkModal=new h(c,a.extend(!0,{},b.options,{tinypattern:b,linkTypes:["internal","external","email","anchor"]})),b.linkModal.show()}else b.linkModal.reinitialize(),b.linkModal.show()},addImageClicked:function(){var b=this;if(null===b.imageModal){var c=a.extend(!0,{},b.options,{tinypattern:b,linkTypes:["image","externalImage"],initialLinkType:"image",text:{insertHeading:"Insert Image"},relatedItems:{baseCriteria:[{i:"Type",o:"plone.app.querystring.operation.list.contains",v:b.options.imageTypes.split(",").concat(b.options.folderTypes.split(","))}],resultTemplate:'<div class="pat-relateditems-result pat-relateditems-type-<%= Type %>"> <span class="pat-relateditems-buttons">  <% if (folderish) { %>     <a class="pat-relateditems-result-browse" href="#" data-path="<%= path %>">       <i class="icon-folder-open"></i>    </a>   <% } %>  <% if (!selected && !folderish) { %>     <a class="pat-relateditems-result-select" href="#">         <i class="icon-plus-sign"></i>     </a>  <% } %> </span> <% if (!folderish) { %>   <span class="pat-relateditems-result-image">     <img src="<%= getURL %>/@@images/image/tile" />   </span> <% } %> <span class="pat-relateditems-result-title"><%= Title %></span> <span class="pat-relateditems-result-path"><%= path %></span></div>',selectionTemplate:'<span class="pat-relateditems-item pat-relateditems-type-<%= Type %>"> <span class="pat-relateditems-result-image">   <img src="<%= getURL %>/@@images/image/tile" /> </span> <span class="pat-relateditems-item-title"><%= Title %></span> <span class="pat-relateditems-item-path"><%= path %></span></span>'}}),d=a("<div/>").insertAfter(b.$el);b.imageModal=new h(d,c),b.imageModal.show()}else b.imageModal.reinitialize(),b.imageModal.show()},fileUploaded:function(a){var b=this;if(null!==a){var c=a.filename,d=c.split(".");if(d=d[d.length-1].toLowerCase(),-1!==["png","jpg","gif","jpeg"].indexOf(d)){var e={src:"resolveuid/"+a.uid+"/@@images/image/preview","class":"image-inline"};e.id="__mcenew",b.tiny.insertContent(b.tiny.dom.createHTML("img",e));var f=b.tiny.dom.get("__mcenew");b.tiny.dom.setAttrib(f,"id",null)}}},fileUploadError:function(){alert("There was an error attempting to upload file. It is possible the file you are uploading is not allowed in the folder you are trying to add it to.")},init:function(){var a=this;a.linkModal=a.imageModal=a.uploadModal=null;var b=a.$el.attr("id");b=void 0===b?"tiny"+Math.floor(65536*(1+Math.random())).toString(16).substring(1):b.replace(/\./g,"-"),a.$el.attr("id",b);var c=a.options.tiny;c.selector="#"+b,c.addLinkClicked=function(){a.addLinkClicked.apply(a,[])},c.addImageClicked=function(){a.addImageClicked.apply(a,[])},c.skin=!1,a.options.base_url||(a.options.base_url=window.location.href),a.options.upload_url=a.options.rel_upload_path?a.options.folder_url+"/"+a.options.rel_upload_path:null,a.options.upload_url?c.uploadFileClicked=function(){a.uploadFileClicked.apply(a,[])}:(c.plugins[0]=c.plugins[0].replace("ploneupload",""),c.toolbar=c.toolbar.replace("ploneupload","")),e.init(c),a.tiny=e.get(b);var d=a.$el.parents("form");d.on("submit",function(){a.tiny.save()})}});return i});