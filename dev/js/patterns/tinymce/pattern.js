define(["jquery","underscore","mockup-patterns-base","mockup-patterns-relateditems","mockup-patterns-modal","tinymce","mockup-patterns-dropzone","dropzone","text!js/patterns/tinymce/templates/result.xml","text!js/patterns/tinymce/templates/selection.xml","mockup-utils","js/patterns/tinymce/links","js/patterns/tinymce/upload"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){"use strict";var n=c.extend({name:"tinymce",defaults:{relatedItems:{attributes:["UID","Title","Description","getURL","Type","path","ModificationDate"],batchSize:20,basePath:"/",vocabularyUrl:null,width:500,maximumSelectionSize:1,placeholder:"Search for item on site..."},text:{insertBtn:"Insert",cancelBtn:"Cancel",insertHeading:"Insert link",title:"Title",internal:"Internal",external:"External",email:"Email",anchor:"Anchor",subject:"Subject",image:"Image",imageAlign:"Align",scale:"Size",alt:"Alternative Text",externalImage:"External Image URI"},prependToUrl:"",appendToUrl:"",linkAttribute:"path",prependToScalePart:"/imagescale/",appendToScalePart:"",scales:"Listing (16x16):listing,Icon (32x32):icon,Tile (64x64):tile,Thumb (128x128):thumb,Mini (200x200):mini,Preview (400x400):preview,Large (768x768):large",targetList:[{text:"Open in this window / frame",value:""},{text:"Open in new window",value:"_blank"},{text:"Open in parent window / frame",value:"_parent"},{text:"Open in top frame (replaces all frames)",value:"_top"}],imageTypes:"Image",folderTypes:"Folder,Plone Site",linkableTypes:"Document,Event,File,Folder,Image,News Item,Topic",tiny:{plugins:["advlist autolink lists charmap print preview anchor ploneupload","searchreplace visualblocks code fullscreen autoresize","insertdatetime media table contextmenu paste plonelink ploneimage"],menubar:"edit table format tools view insert",toolbar:"undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | unlink plonelink ploneimage | ploneupload",autoresize_max_height:1500},rel_upload_path:null,folder_url:null},uploadFileClicked:function(){var b=this;if(null===b.uploadModal){var c=a("<div/>").insertAfter(b.$el);b.uploadModal=new m(c,a.extend(!0,{},b.options,{tinypattern:b,relatedItems:{baseCriteria:[{i:"Type",o:"plone.app.querystring.operation.list.contains",v:b.options.folderTypes.split(",")}],placeholder:"Select a folder to upload to..."}})),b.uploadModal.show()}else b.uploadModal.reinitialize(),b.uploadModal.show()},addLinkClicked:function(){var b=this;if(null===b.linkModal){var c=a("<div/>").insertAfter(b.$el);b.linkModal=new l(c,a.extend(!0,{},b.options,{tinypattern:b,linkTypes:["internal","external","email","anchor"]})),b.linkModal.show()}else b.linkModal.reinitialize(),b.linkModal.show()},addImageClicked:function(){var b=this;if(null===b.imageModal){var c=a.extend(!0,{},b.options,{tinypattern:b,linkTypes:["image","externalImage"],initialLinkType:"image",text:{insertHeading:"Insert Image"},relatedItems:{baseCriteria:[{i:"Type",o:"plone.app.querystring.operation.list.contains",v:b.options.imageTypes.split(",").concat(b.options.folderTypes.split(","))}],selectableTypes:b.options.imageTypes.split(","),resultTemplate:i,selectionTemplate:j}}),d=a("<div/>").insertAfter(b.$el);b.imageModal=new l(d,c),b.imageModal.show()}else b.imageModal.reinitialize(),b.imageModal.show()},generateUrl:function(a){var b=this,c=a[b.options.linkAttribute];return b.options.prependToUrl+c+b.options.appendToUrl},generateImageUrl:function(a,b){var c=this,d=c.generateUrl(a);return d+c.options.prependToScalePart+b+c.options.appendToScalePart},stripGeneratedUrl:function(a){var b=this;if(a=a.split(b.options.prependToScalePart,2)[0],b.options.prependToUrl){var c=a.split(b.options.prependToUrl,2);2===c.length&&(a=c[1])}return b.options.appendToUrl&&(a=a.split(b.options.appendToUrl)[0]),a},getScaleFromUrl:function(a){{var b=this,c=a.split(b.options.prependToScalePart);c[0]}return 2!==c.length?null:(a=b.options.appendToScalePart?c[1].split(b.options.appendToScalePart)[0]:c[1],-1!==a.indexOf("/image_")&&(a=a.split("/image_")[1]),a)},fileUploaded:function(a){var b=this;if(null!==a){var c=a.filename,d=c.split(".");d=d[d.length-1].toLowerCase();var e;if(-1!==["png","jpg","gif","jpeg"].indexOf(d)){e={src:b.generateImageUrl(a,"thumb"),"class":"image-inline"},e.id="__mcenew",b.tiny.insertContent(b.tiny.dom.createHTML("img",e));var f=b.tiny.dom.get("__mcenew");b.tiny.dom.setAttrib(f,"id",null)}else{e={id:"__mcenew"},b.tiny.insertContent(b.tiny.dom.createHTML("a",e));var g=b.tiny.dom.get("__mcenew");b.tiny.dom.setAttrib(g,"id",null),b.tiny.dom.setAttrib(g,"href",b.generateUrl(a)),b.tiny.dom.setHTML(g,c)}}},fileUploadError:function(){alert("There was an error attempting to upload file. It is possible the file you are uploading is not allowed in the folder you are trying to add it to.")},init:function(){var a=this;a.linkModal=a.imageModal=a.uploadModal=null;var b=k.setId(a.$el),c=a.options.tiny;c.selector="#"+b,c.addLinkClicked=function(){a.addLinkClicked.apply(a,[])},c.addImageClicked=function(){a.addImageClicked.apply(a,[])},c.skin=!1,a.options.relatedItems.generateImageUrl=function(b,c){return a.generateImageUrl.apply(a,[b,c])},a.options.base_url||(a.options.base_url=window.location.href),a.options.uploadUrl=a.options.rel_upload_path?a.options.folder_url+"/"+a.options.rel_upload_path:null,a.options.uploadUrl?c.uploadFileClicked=function(){a.uploadFileClicked.apply(a,[])}:(c.plugins[0]=c.plugins[0].replace("ploneupload",""),c.toolbar=c.toolbar.replace("ploneupload","")),f.init(c),a.tiny=f.get(b);var d=a.$el.parents("form");d.on("submit",function(){a.tiny.save()})}});return n});